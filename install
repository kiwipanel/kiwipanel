#!/bin/bash
######################################################################
#                  KiwiPanel - a LOMP stack on Linux                 #
#                                                                    #
#                Author: Vuong Nguyen and contributors               #
#                  Website: https://kiwipanel.com                    #
#                  @since: 2025                                      #
#              Please do not remove copyright. Thanks!               #
#  Please do not copy under any circumstance for commercial reason!  #
######################################################################

######################################################################
# KiwiPanel Installer v0.0.1
# To install KiwiPanel copy the following instruction and paste to the terminal:
# curl -sLO https://raw.githubusercontent.com/kiwipanel/kiwipanel/main/install && chmod +x install && sudo bash install

######################################################################
clear
date
LANG=en_US.UTF-8
if command -v locale-gen >/dev/null 2>&1; then
    locale-gen en_US.UTF-8
fi

export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# Stop on error 
set -euo pipefail
trap 'LogError "Script failed at line $LINENO"' ERR

DEBUG=${DEBUG:-0}
AUTO_UPGRADE=${AUTO_UPGRADE:-0}

# Create log file
KIWIPANEL_DIR="/opt/kiwipanel"
LOG_DIR="$KIWIPANEL_DIR/logs"
LOG_FILE="$LOG_DIR/install.log"

mkdir -p "$LOG_DIR" || {
    echo "Failed to create log directory: $LOG_DIR"
    exit 1
}

touch "$LOG_FILE" || {
    echo "Failed to create log file: $LOG_FILE"
    exit 1
}

chmod 750 "$KIWIPANEL_DIR" "$LOG_DIR"
chmod 640 "$LOG_FILE"

function log() {
    local level="$1"
    shift
    local message="$*"
    local ts

    ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

    echo "$ts [$level] $message" >> "$LOG_FILE"
}

LogInfo()  { log INFO  "$@"; }
LogWarn()  { log WARN  "$@"; }
LogError() { log ERROR "$@"; }
LogDebug() { [[ "$DEBUG" == "1" ]] && log DEBUG "$@"; }

# Utilities ###########################################################
function PrintGreen() {
    local GREEN='\033[0;32m'
    local NC='\033[0m'
    local content="${1}"
    echo ""
    printf "${GREEN}${content}${NC}\n"
    LogInfo "$*"
}

function PrintWarning() {
    local YELLOW_BROWN='\033[38;5;179m' # ANSI color code for yellow-brown
    local NC='\033[0m'                  # Reset to default color
    local content="${1}"
    printf "${YELLOW_BROWN}Warning: ${content}${NC}\n"
     LogWarn "$*"
}

function PrintRed() {
    local RED='\033[0;31m'
    local NC='\033[0m'
    local content="${1}"
    echo ""
    printf "${RED}Error: ${content}${NC}\n"
    LogError "$*"
}


function generatePassword() {
    LENGTH="16"
    if [ ! -z "$1" ]; then
        LENGTH="$1"
    fi
    echo $(openssl rand -base64 64 | tr -dc a-zA-Z0-9=+ | fold -w ${LENGTH} | head -1)
}

function generate_random_string() {
    head -c 64 /dev/urandom | tr -dc 'a-z0-9' | head -c 12
}

# Check for sudo/root privileges######################################
if [ "$(id -u)" -ne 0 ]; then
    PrintRed "❌ You should install KiwiPanel as root or using sudo command."
    exit 1
fi

# Configuration########################################################
readonly KIWIPANEL_PORT=8443
kiwipanel_passcode=""
KIWI_VERSION="latest"
INSTALL_DIR="/opt/kiwipanel"
ZIP_URL="https://github.com/kiwipanel/kiwipanel/releases/download/v0.1.0/kiwipanel.zip"
TMP_ZIP="/tmp/kiwipanel.zip"
# Welcome########################################################
function ShowLogo {
    local kiwipanel_text=$(
        cat <<"EOF"
    ██╗░░██╗██╗░██╗░░░░░░░██╗██╗██████╗░░█████╗░███╗░░██╗███████╗██╗░░░░░
    ██║░██╔╝██║░██║░░██╗░░██║██║██╔══██╗██╔══██╗████╗░██║██╔════╝██║░░░░░
    █████═╝░██║░╚██╗████╗██╔╝██║██████╔╝███████║██╔██╗██║█████╗░░██║░░░░░
    ██╔═██╗░██║░░████╔═████║░██║██╔═══╝░██╔══██║██║╚████║██╔══╝░░██║░░░░░
    ██║░╚██╗██║░░╚██╔╝░╚██╔╝░██║██║░░░░░██║░░██║██║░╚███║███████╗███████╗
    ╚═╝░░╚═╝╚═╝░░░╚═╝░░░╚═╝░░╚═╝╚═╝░░░░░╚═╝░░╚═╝╚═╝░░╚══╝╚══════╝╚══════╝
EOF
    )
    echo ""
    PrintGreen "${kiwipanel_text}"
    echo ""
}

#Check if kiwipanel (CLI) has been installed. Stop if yes.
if systemctl list-unit-files | grep -q "^kiwipanel.service"; then
    PrintRed "KiwiPanel service has already been installed. Abort installation."
    PrintRed "Please install on a fresh compute or manually remove the existing service."
    exit 1
else
    PrintGreen "Thanks for choosing KiwiPanel. Starting installation."
fi

# Detect the system's architecture
ARCHITECTURE=$(uname -m)
#

kiwipanel_d_start_time=$(date +%s)
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' #NC: Not color: reset color to the default
IPADDRESS=$(curl -s --connect-timeout 5 https://cpanel.net/showip.cgi || hostname -I | awk '{print $1}')
DIR=$(pwd)

# Check the current distro and the kernel
distro=$(grep -oP 'PRETTY_NAME="\K[^"]+' /etc/os-release | cut -f1 -d' ')
readonly kernel_version=$(uname -r)
distro_version=$(echo $(lsb_release -c | cut -d':' -f 2))

#Reference: https://www.cloudron.io/get.html
readonly MINIMUM_DISK_SIZE_GB="5"
readonly MINIMUM_MEMORY="420" #on Amazon lightsail 423MB, 512MB is not always available
readonly rootfs_type=$(LC_ALL=C df --output=fstype / | tail -n1)
readonly physical_memory=$(LC_ALL=C free -m | awk '/Mem:/ { print $2 }')
readonly disk_size_bytes=$(LC_ALL=C df --output=size / | tail -n1)
readonly disk_size_gb=$((${disk_size_bytes} / 1024 / 1024))
readonly current_swap=$(free | awk '/^Swap:/ {print $3}')


# Verify the system has minimum requirements met
if [[ "${rootfs_type}" != "ext4" && "${rootfs_type}" != "xfs" ]]; then
    echo "Error: KiwiPanel requires '/' to be ext4 or xfs" # see #364
    exit 1
fi

if [[ "${physical_memory}" -lt "${MINIMUM_MEMORY}" ]]; then
    echo "Error: KiwiPanel requires at least 512MB physical memory"
    exit 1
fi

if [[ "${disk_size_gb}" -lt "${MINIMUM_DISK_SIZE_GB}" ]]; then
    echo "Error: KiwiPanel requires atleast 5GB disk space (Disk space on / is ${disk_size_gb}GB)"
    exit 1
fi



###################################################################################
function welcome() {
    ShowLogo
    printf "${GREEN}========================================================\n${NC}"
    echo "                   KIWIPANEL.COM Scripts                  "
    echo "            Auto Install & Optimize LOMP Stack            "
    printf "${GREEN}========================================================\n${NC}"
    echo ""
    PrintGreen "Installing KiwiPanel..."
    sleep 3
}

# Control Panel path
# @credit: https://github.com/sanvu88/lempstack/blob/master/install
CPANEL="/usr/local/cpanel/cpanel"
DIRECTADMIN="/etc/init.d/directadmin"
PLESK="/usr/local/psa/version"
WEBMIN="/etc/init.d/webmin"
SENTORA="/root/passwords.txt"
HOCVPS="/etc/hocvps/scripts.conf"
VPSSIM="/home/vpssim.conf"
EEV3="/usr/local/bin/ee"
WORDOPS="/usr/local/bin/wo"
KUSANAGI="/home/kusanagi"
CWP="/usr/local/cwpsrv"
VESTA="/usr/local/vesta/"
EEV4="/opt/easyengine"
LARVPS="/etc/larvps/.info.conf"
TINO="/opt/tinopanel"
WEBINOLY="/opt/webinoly/webinoly.conf"
CYBERPANEL="/usr/local/lscp"
WPTANGTOC="/etc/wptt/.wptt.conf"
HOSTVN="var/hostvn/hostvn.conf"
AAPANEL="/www/server/panel"

function check_panel_script() {
    PrintGreen "Checking the existing script or panel... You should install KiwiPanel on a fresh compute!"
    sleep 2

    # aaPanel
    if [ -d /www/server/panel ] || [ -f /usr/bin/bt ]; then
        PrintRed "Your server has aaPanel installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # cPanel / WHM
    if [ -f /var/cpanel/cpanel.config ]; then
        PrintRed "Your server has WHM/cPanel installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # Plesk
    if [ -d /usr/local/psa ]; then
        PrintRed "Your server has Plesk installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # Kusanagi
    if [ -f /etc/kusanagi ]; then
        PrintRed "Your server has Kusanagi installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # DirectAdmin
    if [ -f /usr/local/directadmin/conf/directadmin.conf ]; then
        PrintRed "Your server has DirectAdmin installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # Webmin
    if [ -f /etc/webmin/miniserv.conf ]; then
        PrintRed "Your server has Webmin installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # Webinoly
    if [ -d /opt/webinoly ]; then
        PrintRed "Your server has Webinoly installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # CyberPanel
    if [ -d /usr/local/CyberPanel ]; then
        PrintRed "Your server has CyberPanel installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # LiteSpeed (OLS or Enterprise)
    if [ -d /usr/local/lsws ] || [ -d /home/lsws ]; then
        PrintRed "Your server has LiteSpeed installed — KiwiPanel can only be installed on a fresh VPS."
        exit 1
    fi

    PrintGreen "No conflicting panels detected. Continuing installation..."
    sleep 1
}


function check_architecture() {
    PrintGreen "Checking ARCHITECTURE... Kiwipanel supports 64 bits system only!"
    sleep 2
    #Check the ARCHITECTURE
    #Ref: https://raw.githubusercontent.com/runtipi/runtipi/master/scripts/install.sh
    # Not supported on 32 bits systems.
    # Note: aarch64 [ARM 64-bit (also known as AArch64), armv7: 32-bit ARM]
    local ARCHITECTURE="$(uname -m)"
    if [[ "$ARCHITECTURE" == "armv7"* ]] || [[ "$ARCHITECTURE" == "i686" ]] || [[ "$ARCHITECTURE" == "i386" ]]; then
        PrintRed "KiwiPanel currently does not support the 32 bits systems"
        exit 1
    fi
}
function check_os() {
    PrintGreen "Checking the OS... Kiwipanel currently supports Ubuntu and Debian only!"
    sleep 2
    echo "Your current Kernel: ${kernel_version}"
    echo "Your current Linux distro: ${distro}"
    if [[ "$distro" == "Ubuntu" || "$distro" == "Debian" ]]; then        
        if [[ "$distro" == "Debian" ]]; then
            DebianCheck=$(cat /etc/debian_version)
            # Comparing string
            if [[ "${DebianCheck}" < "10" ]]; then
                echo "Warning: Debian ${DebianCheck} is not supported by KiwiPanel, use Debian 11, 12 or 13 to install"
                exit 1
            fi

        fi

        if [[ "$distro" == "Ubuntu" ]]; then
            UbuntuCheck=$(cat /etc/issue | grep Ubuntu | awk '{print $2}' | cut -f 1 -d '.')
            if [ "${UbuntuCheck}" -lt "18" ]; then
                echo "Ubuntu ${UbuntuCheck} is not supported by KiwiPanel, use Ubuntu20/22 to install"
                exit 1
            fi
        fi
    else
        PrintRed "The current version of KiwiPanel only works on Ubuntu or Debian."
        exit 1
    fi
}

#Check port https://ping.eu/port-chk/check_port_usage() {
function check_port_usage() {
    local port="$1"
    PrintGreen "Checking port $port..."
    if ss -tuln | awk '{print $5}' | grep -q ":$port$"; then
        echo "❌ Port $port is already in use. KiwiPanel needs this port."
        return 1
    fi
    echo "✅ Port $port is free."
}


function check_condition_before_install() {
    PrintGreen "Evaluating your VPS before installing KiwiPanel....."
    sleep 2
    check_os
    check_architecture
    check_panel_script
    check_port_usage 8443
}

#====================================Start Installing KiwiPanel ====================================
function prepare_directories() {
    echo "==> Preparing directories"
    mkdir -p "$INSTALL_DIR"
}

function show_version(){
    LATEST=$(curl -s https://raw.githubusercontent.com/kiwipanel/kiwipanel/refs/heads/main/version.json)
    VERSION=$(echo "$LATEST" | jq -r '.version')
    URL=$(echo "$LATEST" | jq -r '.download_url')
    NOTES=$(echo "$LATEST" | jq -r '.notes')
    echo "Latest Version: $VERSION"    
    echo "Note: $NOTES"
    sleep 1
}

function download_package() {
    echo "==> Downloading KiwiPanel package"
    if ! curl -L --fail "$ZIP_URL" -o "$TMP_ZIP"; then
        echo "❌ Failed to download KiwiPanel package. Exiting."
        exit 1
    fi
}

function extract_package() {
    echo "==> Extracting files"
    unzip -oq "$TMP_ZIP" -d /opt/
}

function create_group_and_user() {
    echo "==> Creating kiwisecure group"
    getent group kiwisecure >/dev/null || groupadd kiwisecure    
    echo "==> Creating kiwipanel user"
    if ! id kiwipanel >/dev/null 2>&1; then
        useradd --system \
            --no-create-home \
            --home-dir "$INSTALL_DIR" \
            --shell /usr/sbin/nologin \
            kiwipanel
    fi    
}


#------------------------------------------------------------Fixing ownership and permissions (because root created files beforehand
function fix_permissions() {
    echo "==> Fixing ownership and permissions"
    chown -R kiwipanel:kiwisecure "$INSTALL_DIR"

    find "$INSTALL_DIR" -type d -exec chmod 750 {} \;
    find "$INSTALL_DIR" -type f -exec chmod 640 {} \;

    if [ -f "$INSTALL_DIR/bin/kiwipanel" ]; then
        chmod 750 "$INSTALL_DIR/bin/kiwipanel"
    else
        echo "⚠️ Warning: binary not found at $INSTALL_DIR/bin/kiwipanel"
    fi
}

function create_system_directories() {
    echo "==> Creating KiwiPanel system directories"

    mkdir -p /etc/kiwipanel/{sites,users}
    mkdir -p /var/log/kiwipanel
    mkdir -p /var/lib/kiwipanel

    chown -R kiwipanel:kiwisecure /etc/kiwipanel
    chown -R kiwipanel:kiwisecure /var/log/kiwipanel
    chown -R kiwipanel:kiwisecure /var/lib/kiwipanel

    chmod 750 /etc/kiwipanel
    chmod 750 /etc/kiwipanel/sites /etc/kiwipanel/users
    chmod 750 /var/log/kiwipanel
    chmod 750 /var/lib/kiwipanel
}

function linkbinary(){
    if [ ! -f "$INSTALL_DIR/bin/kiwipanel" ]; then
        PrintRed "Binary not found at $INSTALL_DIR/bin/kiwipanel"
        exit 1
    fi

    chmod +x "$INSTALL_DIR/bin/kiwipanel"
    ln -sf "$INSTALL_DIR/bin/kiwipanel" /usr/local/bin/kiwipanel
    PrintGreen "Linked kiwipanel → /usr/local/bin/kiwipanel"
}

#------------------------------------------------------------Create passcode to protect login page
function generate_the_passcode() {
    PrintGreen "Geenerating passcode..."
    LogInfo "Entering generate_the_passcode()"

    local META_DIR="/opt/kiwipanel/meta"
    local PASSCODE_FILE="$META_DIR/passcode"
    mkdir -p "$META_DIR"
    if [[ -f "$PASSCODE_FILE" ]]; then
        kiwipanel_passcode=$(tr -d '\n' < "$PASSCODE_FILE")
        echo "[INFO] Passcode loaded."
        return 0
    fi
    kiwipanel_passcode=$(generate_random_string)
    printf '%s\n' "$kiwipanel_passcode" > "$PASSCODE_FILE"
    chown kiwipanel:kiwisecure "$PASSCODE_FILE"
    chmod 640 "$PASSCODE_FILE"
    PrintGreen "Passcode generated."
}

#------------------------------------------------------------Installing systemd service file
function install_systemd_service() {    
    PrintGreen "Installing systemd service..."

    if [ -f /etc/systemd/system/kiwipanel.service ]; then
        cp /etc/systemd/system/kiwipanel.service \
           /etc/systemd/system/kiwipanel.service.bak
    fi

    # Copy systemd service file from extracted ZIP    
    cp "$INSTALL_DIR/data/kiwipanel.service" "/etc/systemd/system/kiwipanel.service"
    chmod 644 /etc/systemd/system/kiwipanel.service

    systemctl daemon-reload
    systemctl enable kiwipanel.service
    systemctl restart kiwipanel.service
}

function install_login_banner() {
    local PROFILE_D="/etc/profile.d/kiwipanel.sh"

    #install is a GNU command
    install -d -m 755 /etc/profile.d

    cat > "$PROFILE_D" <<'EOF'
#!/bin/bash
# =========================================================
# KiwiPanel login banner
# Created by KiwiPanel installer
# =========================================================

# Exit if shell is not interactive
[[ $- != *i* ]] && return

# Restrict execution to root or kiwipanel user
if [[ $EUID -ne 0 && "$USER" != "kiwipanel" ]]; then
    return
fi

# Ensure kiwipanel CLI exists
KIWIPANEL_BIN="$(command -v kiwipanel 2>/dev/null)" || return

echo
"$KIWIPANEL_BIN" status
echo
echo "Type 'kiwipanel' to open the KiwiPanel administration menu."
echo
EOF

    chown root:root "$PROFILE_D"
    chmod 644 "$PROFILE_D"
}

function disable_default_motd() {
    echo "==> Normalizing login banner experience"

    # Debian / Ubuntu
    if [ -d /etc/update-motd.d ]; then
        chmod -x /etc/update-motd.d/* || true
        return
    fi

    # CentOS / RHEL / Alma / Rocky
    if [ -f /etc/redhat-release ]; then
        : > /etc/motd
        : > /etc/issue
        return
    fi
}

function cleanup() {
    rm -f "$TMP_ZIP"
}


#------------------------------------------------------------Create swap
#Recommendation about the amount of swap:
#https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/managing_storage_devices/getting-started-with-swap_managing-storage-devices
function create_swap() {
    echo "==> Checking swap configuration..."

    # Better detection: any active swap or existing /swapfile
    if swapon --show | grep -q . || [ -e /swapfile ]; then
        echo "Swap is already configured. Skipping creation."
        return
    fi

    total_ram_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    available_disk_kb=$(df / | tail -1 | awk '{print $4}')

    # Conservative sizing
    if [[ $total_ram_kb -le $((2 * 1024 * 1024)) ]]; then
        swap_size_kb=$total_ram_kb
    elif [[ $total_ram_kb -le $((8 * 1024 * 1024)) ]]; then
        swap_size_kb=$((2 * 1024 * 1024))
    else
        swap_size_kb=$((1 * 1024 * 1024))
    fi

    needed_kb=$((swap_size_kb + swap_size_kb / 10))  # +10% overhead

    if [[ $available_disk_kb -lt $needed_kb ]]; then
        PrintWarning "Insufficient disk space for ${swap_size_kb}K swap (need ~$((needed_kb/1024/1024 + 1)) GB free). Skipping."
        return
    fi

    echo "==> Creating ${swap_size_kb}K swap file at /swapfile..."

    if ! fallocate -l "${swap_size_kb}K" /swapfile 2>/dev/null; then
        PrintWarning "fallocate failed. Using dd (this may take a while)..."
        dd if=/dev/zero of=/swapfile bs=1M count=$((swap_size_kb / 1024)) status=progress || return 1
    fi

    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile

    # Avoid duplicates in fstab
    if ! grep -q '^/swapfile' /etc/fstab; then
        echo "/swapfile none swap sw 0 0" | tee -a /etc/fstab
    fi

    echo "Swap file created and enabled."
}

function InstallBaseCentos() {
    PrintGreen "Updating system and installing base tools on CentOS-based distro..."    
    #dnf detection (future-proofing), dnf is available on CentOS 8+, AlmaLinux, RockyLinux
    PKG_MGR=$(command -v dnf || command -v yum) || {
        PrintRed "No supported package manager found"
        exit 1
    }
    $PKG_MGR update -y || { PrintRed "Failed to update package lists"; exit 1; }
    #--no-install-recommends is APT-only. For YUM/DNF, we just do a standard upgrade.    
    $PKG_MGR upgrade -y || { PrintRed "System upgrade failed"; exit 1; }

    $PKG_MGR install -y ca-certificates || {
        PrintRed "Failed to install ca-certificates"
        exit 1
    }
    
    #Install ca-certificates first, then EPEL.
    rpm -q epel-release >/dev/null 2>&1 || $PKG_MGR install -y epel-release

    $PKG_MGR install -y \
        gnupg2 \
        redhat-lsb-core \
        procps-ng \
        wget curl git zip unzip nano \
        openssl cronie lsof jq || {
            PrintRed "Failed to install base packages"
            exit 1
        }
        
    #The || true ensures the script continues even if crond is already enabled/started or the command fails 
    #(e.g., in a container where systemd isn't running).
    systemctl enable crond >/dev/null 2>&1 || true
    systemctl start crond  >/dev/null 2>&1 || true
}

function InstallBaseUbuntu() {
    PrintGreen "Updating system and installing base tools on Debian-based distro..."   
    export DEBIAN_FRONTEND=noninteractive        
    apt-get update -y || { PrintRed "Failed to update package lists"; exit 1; }
    #Using --no-install-recommends on upgrade is a great practice, especially in automated scripts, 
    #as it prevents potentially unwanted package creep.    
    
    if [[ "$AUTO_UPGRADE" == "1" ]]; then
        apt-get -y upgrade --no-install-recommends || {
            PrintRed "System upgrade failed"
            exit 1
        }   
    fi

    apt-get install -y \
        ca-certificates \
        gnupg \
        lsb-release \
        procps \
        wget curl git zip unzip nano \
        openssl cron lsof jq || {
            PrintRed "Failed to install base packages"
            exit 1
        }
    #Ubuntu often installs but does not start cron in minimal images. Ensure it's started.    
    systemctl enable cron >/dev/null 2>&1 || true
    systemctl start cron  >/dev/null 2>&1 || true
}


# Install the base system for the specified distribution.
function install_base() {    
    PrintGreen "Installing base system dependencies..."
    if [[ "$distro" == "Ubuntu" || "$distro" == "Debian" ]]; then        
        InstallBaseUbuntu    
    elif [[ "$distro" == "AlmaLinux" || "$distro" == "CentOS" || "$distro" == "Rocky" ]]; then
        InstallBaseCentos
    fi
}


function verify(){
    echo "==> Verifying ownership"
    for path in /opt/kiwipanel /etc/kiwipanel /var/log/kiwipanel /var/lib/kiwipanel; do
    owner=$(stat -c "%U:%G" "$path")
    if [ "$owner" != "kiwipanel:kiwisecure" ]; then
        PrintWarning "$path ownership is $owner (expected kiwipanel:kiwisecure)"
    fi
    done
}


function successMessage() {    
    printf " \n"
    PrintGreen "Kiwiscript has been successfully installed on your VPS!"
    kiwipanel_d_end_time=$(date +%s)
    elapsed=$((kiwipanel_d_end_time - kiwipanel_d_start_time))
    echo "$(tput setaf 2)Total time installed: ${elapsed} seconds.$(tput sgr0)"
    printf " \n"
    echo "
    "$(tput setaf 2)================================Install KiwiPanel Done!==============================$(tput sgr0)"

    Login at : http://$IPADDRESS:$KIWIPANEL_PORT/$kiwipanel_passcode

    "$(tput setaf 2)=====================================================================================$(tput sgr0)"
    "
    LogInfo "Installation completed successfully"
}

function installkiwipanel() {
    prepare_directories
    show_version
    download_package
    extract_package
    create_group_and_user
    create_system_directories
    fix_permissions
    linkbinary
    generate_the_passcode 
    install_systemd_service
    install_login_banner
    disable_default_motd
}

function main() {
    welcome
    check_condition_before_install
    create_swap   
    install_base        
    installkiwipanel
    verify
    successMessage
    cleanup
}

main
