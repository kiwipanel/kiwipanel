#!/bin/bash
######################################################################
#                  KiwiPanel - a LOMP stack on Linux                 #
#                                                                    #
#                Author: Vuong Nguyen and contributors               #
#                  Website: https://kiwipanel.com                    #
#                  @since: 2025                                      #
#              Please do not remove copyright. Thanks!               #
#  Please do not copy under any circumstance for commercial reason!  #
######################################################################

######################################################################
# KiwiPanel Installer v0.0.1
# To install KiwiPanel copy the following instruction and paste to the terminal:
# curl -sLO https://raw.githubusercontent.com/kiwipanel/kiwipanel/main/install && chmod +x install && sudo bash install

######################################################################
clear
date
LANG=en_US.UTF-8
locale-gen en_US.UTF-8
export LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8
# Stop on error 
set -e

# Check for sudo/root privileges######################################
if [ "$(id -u)" -ne 0 ]; then
    PrintRed "‚ùå You should install KiwiPanel as root or using sudo command."
    exit 1
fi

# Configuration########################################################
readonly KIWIPANEL_PORT=8443
readonly KIWI_VERSION="latest"
readonly INSTALL_DIR="/usr/local/bin"
readonly OPT_DIR="/opt/kiwipanel"
readonly SERVICE_FILE="/opt/kiwipanel/data/kiwipanel.service"


# Utilities ###########################################################
function PrintGreen() {
    local GREEN='\033[0;32m'
    local NC='\033[0m'
    local content="${1}"
    echo ""
    printf "${GREEN}${content}${NC}\n"
}
function PrintRed() {
    local RED='\033[0;31m'
    local NC='\033[0m'
    local content="${1}"
    echo ""
    printf "${RED}Error: ${content}${NC}\n"
}

function PrintWarning() {
    local YELLOW_BROWN='\033[38;5;179m' # ANSI color code for yellow-brown
    local NC='\033[0m'                  # Reset to default color
    local content="${1}"
    printf "${YELLOW_BROWN}Warning: ${content}${NC}\n"
}



# Welcome########################################################
function ShowLogo {
    local kiwipanel_text=$(
        cat <<"EOF"
    ‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïó‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñë‚ñë‚ñë‚ñë‚ñë
    ‚ñà‚ñà‚ïë‚ñë‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïê‚ïù‚ñë‚ñà‚ñà‚ïë‚ñë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë
    ‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ñà‚ñà‚ïë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù‚ñë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë
    ‚ñà‚ñà‚ïë‚ñë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñë‚ñë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ïö‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
    ‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
    )
    echo ""
    PrintGreen "${kiwipanel_text}"
    echo ""
}




#Check if kiwipanel (CLI) has been installed. Stop if yes.
if systemctl list-unit-files | grep -q "^kiwipanel.service"; then
    PrintRed "KiwiPanel service has already been installed. Abort installation."
    PrintRed "Please install on a fresh compute or manually remove the existing service."
    exit 1
else
    PrintGreen "KiwiPanel service does not exist. You are good to go."
fi

#Create necessary folders and backup if needed

echo "üîß Creating KiwiPanel directory structure..."

# Panel core folders
mkdir -p /opt/kiwipanel/{bin,config,logs,data,modules,templates,ssl}


# Backup folder
mkdir -p /var/backups/kiwipanel/{system,users,domains}

echo "‚úÖ Folders created successfully."

#Setting permissions
echo "üîß Setting permissions..."
chown -R root:root /opt/kiwipanel
chmod -R 700 /opt/kiwipanel
chown -R root:root /var/backups/kiwipanel
chmod -R 700 /var/backups/kiwipanel
# Ensure www folder exists and safe
chmod 755 /var/www

# User folders will be created dynamically later
echo "‚úÖ Permissions set."

# Detect the system's architecture
ARCHITECTURE=$(uname -m)
#

function run_and_check() {
    local command_to_run="$1"
    $command_to_run
    local exit_code=$?
    if [ $exit_code -eq 0 ]; then
        PrintGreen "Command $command_to_run succeeded"
    else
        PrintRed "Command $command_to_run failed with exit code $exit_code"
        if [ $exit_code -eq 5 ]; then
            # Exit code 5 typically indicates that the service is not loaded
            PrintWarning "Service is not loaded or does not exist."
        else
            exit 1
        fi
    fi
}


function move_nested_file() {
    # Check if both source and destination folders are provided
    if [ $# -ne 2 ]; then
        echo "Usage: moving folder : source_folder destination_folder"
        return 1
    fi
    local source_folder="$1"
    local destination_folder="$2"

    # Check if the source folder exists
    if [ ! -d "$source_folder" ]; then
        echo "Source folder '$source_folder' not found."
        return 1
    fi

    # Check if the source folder is empty
    if [ -z "$(ls -A "$source_folder")" ]; then
        echo "Source folder '$source_folder' is empty. Nothing to move."
        return 0
    fi

    # Check if the destination folder exists; create it if not
    if [ ! -d "$destination_folder" ]; then
        mkdir -p "$destination_folder" || return 1
    fi

    # Move the content of the source folder to the destination folder
    mv "$source_folder"/* "$destination_folder"/ || return 1
    echo "The content of '$source_folder' has been moved to '$destination_folder'."
}

function rename_folder() {
    if [ $# -ne 1 ]; then
        echo "Usage: rename_folder <old_folder_name>"
        return 1
    fi

    old_folder_name="$1"
    current_datetime=$(date +"%Y_%m_%d_%H_%M")
    new_folder_name="${old_folder_name%_*}_${current_datetime}"

    if [ ! -d "$old_folder_name" ]; then
        echo "Error: Folder '$old_folder_name' not found."
        return 1
    fi

    echo "Renaming folder $old_folder_name to $new_folder_name..."
    mv "$old_folder_name" "$new_folder_name"

    if [ $? -eq 0 ]; then
        echo "Rename operation successful."

        # Check if new_folder_name is empty and delete it
        if [ -z "$(ls -A "$new_folder_name")" ]; then
            rmdir "$new_folder_name"
            echo "Deleted empty folder: $new_folder_name"
        fi

    else
        echo "Error: Failed to rename the folder."
        return 1
    fi
}


# Setting and declaring

kiwipanel_d_start_time=$(date +%s)
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' #NC: Not color: reset color to the default
IPADDRESS=$(curl -s -L -sk --connect-timeout 10 --retry 3 --retry-delay 0 http://cpanel.net/showip.cgi)
readonly DIR=$(pwd)
readonly HOSTNAME=$(hostname)
# Check the current distro and the kernel
readonly distro=$(grep -oP 'PRETTY_NAME="\K[^"]+' /etc/os-release | cut -f1 -d' ')
readonly kernel_version=$(uname -r)
readonly distro_version=$(echo $(lsb_release -c | cut -d':' -f 2))

#Reference: https://www.cloudron.io/get.html
readonly MINIMUM_DISK_SIZE_GB="10"
readonly MINIMUM_MEMORY="420" #on Amazon lightsail 423MB,
readonly curl="curl --fail --connect-timeout 20 --retry 10 --retry-delay 2 --max-time 2400"
readonly rootfs_type=$(LC_ALL=C df --output=fstype / | tail -n1)
readonly physical_memory=$(LC_ALL=C free -m | awk '/Mem:/ { print $2 }')
readonly disk_size_bytes=$(LC_ALL=C df --output=size / | tail -n1)
readonly disk_size_gb=$((${disk_size_bytes} / 1024 / 1024))
readonly current_swap=$(free | awk '/^Swap:/ {print $3}')
readonly cpu_cores=$(grep -c "processor" /proc/cpuinfo)

# Verify the system has minimum requirements met
if [[ "${rootfs_type}" != "ext4" && "${rootfs_type}" != "xfs" ]]; then
    echo "Error: KiwiPanel requires '/' to be ext4 or xfs" # see #364
    exit 1
fi

if [[ "${physical_memory}" -lt "${MINIMUM_MEMORY}" ]]; then
    echo "Error: KiwiPanel requires at least 512MB physical memory"
    exit 1
fi

if [[ "${disk_size_gb}" -lt "${MINIMUM_DISK_SIZE_GB}" ]]; then
    echo "Error: KiwiPanel requires atleast 10GB disk space (Disk space on / is ${disk_size_gb}GB)"
    exit 1
fi

function generatePassword {
    LENGTH="16"
    if [ ! -z "$1" ]; then
        LENGTH="$1"
    fi
    echo $(openssl rand -base64 64 | tr -dc a-zA-Z0-9=+ | fold -w ${LENGTH} | head -1)
}


function generate_random_string() {
    cat /dev/urandom | tr -dc 'a-z0-9' | head -c 9
}
readonly kiwipanel_passcode=$(generate_random_string)
readonly kiwipanel_username=$(generate_random_string)
readonly kiwipanel_password=$(generatePassword 12)


###################################################################################
function welcome() {
    ShowLogo
    printf "${GREEN}========================================================\n${NC}"
    echo "                   KIWIPANEL.COM Scripts                  "
    echo "            Auto Install & Optimize LOMP Stack            "
    printf "${GREEN}========================================================\n${NC}"
    echo ""
    PrintGreen "Installing KiwiPanel..."
    sleep 3
}

# Control Panel path
# @credit: https://github.com/sanvu88/lempstack/blob/master/install
CPANEL="/usr/local/cpanel/cpanel"
DIRECTADMIN="/etc/init.d/directadmin"
PLESK="/usr/local/psa/version"
WEBMIN="/etc/init.d/webmin"
SENTORA="/root/passwords.txt"
HOCVPS="/etc/hocvps/scripts.conf"
VPSSIM="/home/vpssim.conf"
EEV3="/usr/local/bin/ee"
WORDOPS="/usr/local/bin/wo"
KUSANAGI="/home/kusanagi"
CWP="/usr/local/cwpsrv"
VESTA="/usr/local/vesta/"
EEV4="/opt/easyengine"
LARVPS="/etc/larvps/.info.conf"
TINO="/opt/tinopanel"
WEBINOLY="/opt/webinoly/webinoly.conf"
CYBERPANEL="/usr/local/lscp"
WPTANGTOC="/etc/wptt/.wptt.conf"
HOSTVN="var/hostvn/hostvn.conf"
AAPANEL="/www/server/panel"

function check_panel_script() {
    PrintGreen "Checking the existing script or panel... You should install KiwiPanel on a fresh compute!"
    sleep 2

    # aaPanel
    if [ -d /www/server/panel ] || [ -f /usr/bin/bt ]; then
        PrintRed "Your server has aaPanel installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # cPanel / WHM
    if [ -f /var/cpanel/cpanel.config ]; then
        PrintRed "Your server has WHM/cPanel installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # Plesk
    if [ -d /usr/local/psa ]; then
        PrintRed "Your server has Plesk installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # Kusanagi
    if [ -f /etc/kusanagi ]; then
        PrintRed "Your server has Kusanagi installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # DirectAdmin
    if [ -f /usr/local/directadmin/conf/directadmin.conf ]; then
        PrintRed "Your server has DirectAdmin installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # Webmin
    if [ -f /etc/webmin/miniserv.conf ]; then
        PrintRed "Your server has Webmin installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # Webinoly
    if [ -d /opt/webinoly ]; then
        PrintRed "Your server has Webinoly installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # CyberPanel
    if [ -d /usr/local/CyberPanel ]; then
        PrintRed "Your server has CyberPanel installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # LiteSpeed (OLS or Enterprise)
    if [ -d /usr/local/lsws ] || [ -d /home/lsws ]; then
        PrintRed "Your server has LiteSpeed installed ‚Äî KiwiPanel currently requires Nginx."
        exit 1
    fi

    PrintGreen "No conflicting panels detected. Continuing installation..."
    sleep 1
}


function check_architecture() {
    PrintGreen "Checking ARCHITECTURE... Kiwipanel supports 64 bits system only!"
    sleep 2
    #Check the ARCHITECTURE
    #Ref: https://raw.githubusercontent.com/runtipi/runtipi/master/scripts/install.sh
    # Not supported on 32 bits systems.
    # Note: aarch64 [ARM 64-bit (also known as AArch64), armv7: 32-bit ARM]
    local ARCHITECTURE="$(uname -m)"
    if [[ "$ARCHITECTURE" == "armv7"* ]] || [[ "$ARCHITECTURE" == "i686" ]] || [[ "$ARCHITECTURE" == "i386" ]]; then
        PrintRed "KiwiPanel currently does not support the 32 bits systems"
        exit 1
    fi
}
function check_os() {
    PrintGreen "Checking the OS... Kiwipanel currently supports Ubuntu and Debian only!More to come, surely"
    sleep 2
    echo "Your current Kernel: ${kernel_version}"
    echo "Your current Linux distro: ${distro}"
    if [[ "$distro" == "Ubuntu" || "$distro" == "Debian" ]]; then        
        if [[ "$distro" == "Debian" ]]; then
            DebianCheck=$(cat /etc/debian_version)
            # Comparing string
            if [[ "${DebianCheck}" < "10" ]]; then
                echo "Warning: Debian ${DebianCheck} is not supported by KiwiPanel, use Debian 11 or 12 to install"
                exit 1
            fi

        fi

        if [[ "$distro" == "Ubuntu" ]]; then
            UbuntuCheck=$(cat /etc/issue | grep Ubuntu | awk '{print $2}' | cut -f 1 -d '.')
            if [ "${UbuntuCheck}" -lt "18" ]; then
                echo "Ubuntu ${UbuntuCheck} is not supported by KiwiPanel, use Ubuntu20/22 to install"
                exit 1
            fi
        fi
    else
        PrintRed "The current version of KiwiPanel only works on Ubuntu or Debian."
        exit 1
    fi
}

function check_port_usage() {
    PrintGreen "Checking the port 8443..."
    sleep 2
    local port_number=$1
    # Check if lsof is installed [Will be surely installed]
    if ! [ -x "$(command -v lsof)" ]; then
        echo 'Error: lsof is not installed. Please install lsof to use this script.' >&2
        return 1
    fi
    # Check if the port is in use
    if lsof -i :$port_number >/dev/null 2>&1; then
        echo "Port $port_number is in use. You might check your compute as KiwiPanel will run on the port 8443."
        exit 1
    else
        echo "Port $port_number is not in use. You are good to go!"
    fi
}

function check_condition_before_install() {
    PrintGreen "Evaluating your VPS before installing KiwiPanel....."
    sleep 2
    check_os
    check_architecture
    check_panel_script
    check_port_usage 8443
}


#====================================Start Installing KiwiPanel ====================================
INSTALL_DIR="/opt/kiwipanel"
ZIP_URL="https://github.com/kiwipanel/kiwipanel/releases/download/v0.1.0/kiwipanel.zip"
TMP_ZIP="/tmp/kiwipanel.zip"
#------------------------------------------------------------Downloading and extracting files
mkdir -p $INSTALL_DIR

echo "==> Downloading KiwiPanel package"
if ! curl -L --fail "$ZIP_URL" -o "$TMP_ZIP"; then
    echo "‚ùå Failed to download KiwiPanel package. Exiting."
    exit 1
fi

# Install zip if needed. Extract the files
echo "==> Checking unzip installation"
if ! command -v unzip >/dev/null 2>&1; then
    echo "Installing unzip package..."
    apt-get update -y && apt-get install -y unzip
fi

echo "==> Extracting files"
unzip -oq "$TMP_ZIP" -d /opt/

#Creating user and group
echo "==> Creating kiwipanel system user"
if ! id kiwipanel >/dev/null 2>&1; then
    useradd --system \
        --no-create-home \
        --home-dir "$INSTALL_DIR" \
        --shell /usr/sbin/nologin \
        kiwipanel
fi

echo "==> Creating kiwisecure group"
if ! getent group kiwisecure >/dev/null 2>&1; then
    groupadd kiwisecure
fi

#------------------------------------------------------------Fixing ownership and permissions (because root created files beforehand
echo "==> Fixing ownership"
chown -R kiwipanel:kiwisecure /opt/kiwipanel

echo "==> Setting permissions"
find /opt/kiwipanel -type d -exec chmod 750 {} \;
find /opt/kiwipanel -type f -exec chmod 640 {} \;

# Ensure this path is correct based on the zip file structure
if [ -f "$INSTALL_DIR/bin/kiwipanel" ]; then
    chmod 750 "$INSTALL_DIR/bin/kiwipanel"
else
    echo "Warning: Binary not found at $INSTALL_DIR/bin/kiwipanel"
fi

#Clean up
rm -f /tmp/kiwipanel.zip
#------------------------------------------------------------Installing systemd service file
echo "==> Installing systemd service"

#Backup existing systemd service file if exists
if [ -f /etc/systemd/system/kiwipanel.service ]; then
    cp /etc/systemd/system/kiwipanel.service /etc/systemd/system/kiwipanel.service.bak
fi
# Copy systemd service file from extracted ZIP
cp /opt/kiwipanel/data/kiwipanel.service /etc/systemd/system/kiwipanel.service
# Make sure permissions are correct
chmod 644 /etc/systemd/system/kiwipanel.service
echo "==> Starting KiwiPanel service"
systemctl daemon-reload
systemctl enable kiwipanel.service
systemctl restart kiwipanel.service

#------------------------------------------------------------Create swap
#Recommendation about the amount of swap:
#https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/managing_storage_devices/getting-started-with-swap_managing-storage-devices
function create_swap() {
    # Check if a swap file already exists
    if [ -e /swapfile ]; then
        echo "Swap file already exists. Skipping creation."
        return
    fi

    # Get the total amount of RAM in kilobytes
    total_ram_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    # Calculate the size for the swap file (assuming the same size as RAM)
    swap_size_kb=$total_ram_kb
    # Create a swap file
    sudo fallocate -l ${swap_size_kb}K /swapfile
    # Set appropriate permissions for the swap file
    sudo chmod 600 /swapfile
    # Make it a swap file
    sudo mkswap /swapfile
    # Enable the swap file
    sudo swapon /swapfile
    # Add an entry to /etc/fstab to make the swap file persistent
    echo "/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab
}

function UpdateUbuntu() {
    PrintGreen "Updating the system..."
    sleep 3
    sudo apt-get update && sudo apt-get -y upgrade
}
function BaseCentos() {
    PrintGreen "Installing the base tools..."
    sleep 3
    sudo yum install wget curl git zip unzip nano openssl cron lsof -y
}
function BaseUbuntu() {
    printf " \n"
    echo "$(tput setaf 2)Installing the base tools....$(tput sgr0)"
    sleep 3
    sudo apt install wget curl git zip unzip nano openssl cron lsof -y
}

# Install the base system for the specified distribution.
function install_base() {
    echo "Installing the base tools including wget curl git zip unzip nano..."
    if [[ "$distro" == "Ubuntu" || "$distro" == "Debian" ]]; then
        UpdateUbuntu
        BaseUbuntu
    elif [ "$distro" == "AlmaLinux" ] || [ "$distro" == "Centos" ] || [ "$distro" == "RockyLinux" ]; then
        BaseCentos
    fi
}

#Just in case it is needed
function remove_apache2() {
    #The || true at the end ensures that the entire command sequence returns a successful exit status (0),
    # even if the systemctl command returns a non-zero exit status.
    sudo systemctl --quiet disable --now apache2 || true
    sudo service apache2 stop
    sudo apt remove --autoremove apache2 -y
    sudo apt purge apache2 apache2-utils -y
    sudo apt remove apache2 apache2-utils -y
    sudo apt autoremove apache2 apache2-utils -y
    sudo rm -r /usr/sbin/apache2
    sudo rm -r /usr/lib/apache2
    sudo rm -r /etc/apache2
    sudo rm -r /usr/share/man/man8/apache2.8.gz
}


function open_port() {
    local PORT_NUMBER="$1"    
    echo "‚Üí Opening port $PORT_NUMBER ..."
    # 1) UFW (Ubuntu)
    if command -v ufw >/dev/null 2>&1; then
        ufw allow "$PORT_NUMBER"/tcp || true
        echo "‚úî Port opened via UFW"
        return 0
    fi
    # 2) firewalld (CentOS, Alma, Rocky)
    if command -v firewall-cmd >/dev/null 2>&1; then
        firewall-cmd --permanent --add-port="$PORT_NUMBER"/tcp || true
        firewall-cmd --reload || true
        echo "‚úî Port opened via firewalld"
        return 0
    fi
    # 3) iptables (nft or legacy)
    if command -v iptables >/dev/null 2>&1; then
        iptables -I INPUT -p tcp --dport "$PORT_NUMBER" -j ACCEPT || true

        # Try persistence methods
        if command -v netfilter-persistent >/dev/null 2>&1; then
            netfilter-persistent save || true
        elif command -v iptables-save >/dev/null 2>&1; then
            iptables-save >/etc/iptables/rules.v4 2>/dev/null || true
        fi

        echo "‚úî Port opened via iptables"
        return 0
    fi

    echo "‚ö† No supported firewall found. Port NOT automatically opened."
    return 1
}



function move_file() {
    # usr: unix system resources
    sudo mv -v kiwi /usr/bin
    sudo chmod 755 /usr/bin/kiwi

}


function start_systemd() {
    
    #sudo systemctl daemon-reload
    run_and_check "sudo systemctl daemon-reload"
    #sudo systemctl start kiwipanel
    run_and_check "sudo systemctl start kiwipanel"
    #Will restart automatically when VPS restarts
    #sudo systemctl enable kiwipanel
    run_and_check "sudo systemctl enable kiwipanel"
}

function setup_kiwipanel() {
    # Check if there is any other non-root process running on the port KIWIPANEL_PORT
    local KIWIPANEL_RUNNING=$(lsof -u^root -i:"$KIWIPANEL_PORT" -P -n -sTCP:LISTEN)
    echo "KIWIPANEL_RUNNING: $KIWIPANEL_RUNNING"
    if [ ! -z "${KIWIPANEL_RUNNING}" ]; then
        PrintRed "Cannot install KiwiPanel. Some other process is running on port $KIWIPANEL_PORT which does not belong to root!."
        exit 1
    fi
    successMessage
}

function successMessage() {    
    printf " \n"
    PrintGreen "Kiwiscript has been successfully installed on your VPS!"
    kiwipanel_d_end_time=$(date +%s)
    elapsed=$((kiwipanel_d_end_time - kiwipanel_d_start_time))
    echo "$(tput setaf 2)Total time installed: ${elapsed} seconds.$(tput sgr0)"
    printf " \n"
    echo "
    "$(tput setaf 2)================================Install KiwiPanel Done!==============================$(tput sgr0)"

    Register and Login at : http://$IPADDRESS:$KIWIPANEL_PORT/$kiwipanel_passcode

    "$(tput setaf 2)=====================================================================================$(tput sgr0)"
    "
}

clean_up() {
    #Clean the history of the commands that have been used during the current shell session.
    history -c
    # Clean the local repository of retrieved package files
    apt clean
    #Remove the script itself
    rm $0
    PrintGreen "Cleaning up is done!"
}

function main() {
    welcome
    check_condition_before_install
    create_swap
    install_base
    remove_apache2    
    open_port "$KIWIPANEL_PORT"    
    start_systemd
    setup_kiwipanel
    # Using the keyword `trap` to call the function cleanUp on script exit (EXIT signal)
    #trap clean_up EXIT
}

main
