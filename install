#!/bin/bash
#######################################################
# KiwiPanel Installer v0.0.1
# To install KiwiPanel type:
# curl -sLO # curl -sLO https://install.kiwipanel.org/install && chmod +x install && sudo bash install

#######################################################
clear;
LANG=en_US.UTF-8

kiwipanel_d_start_time=$(date +%s)
echo "$(tput setaf 2)Installing KiwiPanel...$(tput sgr0)" 
sleep 3;  

# Check for sudo/root privileges
if [[ $(whoami) != "root" ]]; then
	echo "$(tput setaf 1)You should install KiwiPanel as root or using sudo.$(tput sgr0)"	
	exit 1
fi

function check_panel_script(){
  echo "$(tput setaf 2)Checking the current script or panel, if any....$(tput sgr0)" 
  sleep 3;  
  if [ -f /var/cpanel/cpanel.config ]; then
    clear
    echo "Your server installed WHM/Cpanel, please reinstall to use KiwiPanel."
    exit
    fi

    if [ -f /etc/psa/.psa.shadow ]; then
    clear
    echo "Your server installed Plesk, please reinstall to use KiwiPanel."
    exit
    fi

    if [ -f /etc/init.d/directadmin ]; then
    clear
    echo "Your server installed DirectAdmin, please reinstall to use KiwiPanel."
    exit
    fi

    if [ -f /etc/init.d/webmin ]; then
    clear
    echo "Your server installed Webmin, please reinstall to use KiwiPanel."
    exit
    fi
}
#Check the ARCHITECTURE
#Ref: https://raw.githubusercontent.com/runtipi/runtipi/master/scripts/install.sh
# Not supported on 32 bits systems. 
# Note: aarch64 [ARM 64-bit (also known as AArch64), armv7: 32-bit ARM]
ARCHITECTURE="$(uname -m)"
if [[ "$ARCHITECTURE" == "armv7"* ]] || [[ "$ARCHITECTURE" == "i686" ]] || [[ "$ARCHITECTURE" == "i386" ]]; then
  echo "KiwiPanel is not supported on 32 bits systems"
  exit 1
fi

# Check the current distro and the kernel
readonly distro=$(grep -oP 'PRETTY_NAME="\K[^"]+' /etc/os-release | cut -f1 -d' ')
readonly kernel_version=$(uname -r)

echo "Your current Kernel: ${kernel_version}"
echo "Your current Linux distro: ${distro}"

function check_os() {
    if [[ "$distro" != "Ubuntu" ]]; then
        echo "$(tput setaf 1)The current version of KiwiPanel only works on Ubuntu.$(tput sgr0)"
        exit 1
    fi
}

IP=`curl -s -L http://cpanel.net/showip.cgi`
echo "$(tput setaf 2)Your IP address: $IP$(tput sgr0)" 
sleep 3;  


function check_file_availability() {
  if [ -e "$1" ]; then
    return 0  # File exists, return true (0)
  else
    return 1  # File does not exist, return false (non-zero)
  fi
}

function UpdateUbuntu(){
    printf " \n"
    echo "$(tput setaf 2)Updating the system....$(tput sgr0)"     
    sleep 3;
    sudo apt-get update && sudo apt-get -y upgrade
}


function BaseCentos(){   
    printf " \n"
    echo "$(tput setaf 2)Installing the base tools....$(tput sgr0)" 
    sleep 3;         
    sudo yum install wget curl git-all zip nano -y
}

function BaseUbuntu(){    
    printf " \n"
    echo "$(tput setaf 2)Installing the base tools....$(tput sgr0)" 
    sleep 3;    
    sudo apt install wget curl git-all zip nano -y

}

 # Install the base system for the specified distribution.
function installBase(){      
    if [ "$distro" == "Ubuntu" ]; then
        UpdateUbuntu
        BaseUbuntu
    elif [ "$distro" == "AlmaLinux" ] || [ "$distro" == "Centos" ] || [ "$distro" == "RockyLinux" ]; then
        BaseCentos
    fi
}

function moveHome(){
    cd /home
}


function Clone(){  
  sudo git clone https://github.com/kiwipanel/scaffolding.git
  cd scaffolding  
}

open_port() {
    local port=$1
    # Check if UFW is installed
    if ! command -v ufw &> /dev/null; then
        echo "UFW is not installed. Installing..."
        sudo apt-get install ufw
    fi
    # Allow the specified port
    sudo ufw allow $port
    # Reload UFW
    sudo ufw reload
    # Display status
    sudo ufw status
}


function removeFile() {
    cd /usr/bin
    if check_file_availability "$1"; then
        sudo rm "$1"
    fi
}

function moveFile() {
    sudo mv -v kiwi /usr/bin
    sudo chmod 755 /usr/bin/kiwi    
}

function StartSystem(){
    sudo systemctl start kiwipanel
}

function Success(){
    StartSystem

    printf " \n"
    echo "$(tput setaf 2)Kiwiscript has been successfully installed on your VPS!.$(tput sgr0)"   
    kiwipanel_d_end_time=$(date +%s)
    elapsed=$((kiwipanel_d_end_time - kiwipanel_d_start_time))     
    echo "$(tput setaf 2)Total time installed: ${elapsed} seconds.$(tput sgr0)"      
    printf " \n"     
    echo "
    
    "$(tput setaf 2)================================Install KiwiPanel Done!==============================$(tput sgr0)"        
    
    Register and Login at : http://$IP:8443     

    "$(tput setaf 2)=====================================================================================$(tput sgr0)"    
    "
}

#Reference for future work: https://raw.githubusercontent.com/runtipi/runtipi/master/scripts/install.sh
function install_docker() {
  local os="${1}"
  echo "Installing docker for os ${os}"
  echo "Your sudo password might be asked to install docker"

  if [[ "${os}" == "debian" ]]; then
    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y ca-certificates curl gnupg lsb-release
    sudo mkdir -p /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
    sudo DEBIAN_FRONTEND=noninteractive apt-get update -y
    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
    return 0
  elif [[ "${os}" == "ubuntu" || "${os}" == "pop" ]]; then
    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y ca-certificates curl gnupg lsb-release
    sudo mkdir -p /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
    sudo DEBIAN_FRONTEND=noninteractive apt-get update -y
    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
    return 0
  elif [[ "${os}" == "centos" ]]; then
    sudo yum install -y yum-utils
    sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
    sudo yum install -y --allowerasing docker-ce docker-ce-cli containerd.io docker-compose-plugin
    sudo systemctl start docker
    sudo systemctl enable docker
    return 0
  elif [[ "${os}" == "rocky" ]]; then
    sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
    sudo dnf -y install docker-ce docker-ce-cli containerd.io docker-compose-plugin
    sudo systemctl start docker
    sudo systemctl enable docker
    return 0
  elif [[ "${os}" == "fedora" ]]; then
    sudo dnf -y install dnf-plugins-core
    sudo dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
    sudo dnf -y install docker-ce docker-ce-cli containerd.io docker-compose-plugin
    sudo systemctl start docker
    sudo systemctl enable docker
    return 0
  elif [[ "${os}" == "arch" ]]; then
    sudo pacman -Sy --noconfirm docker docker-compose
    sudo systemctl start docker.service
    sudo systemctl enable docker.service
    return 0
  else
    return 1
  fi
}

if ! command -v docker >/dev/null; then
  echo "Installing docker"
  install_docker "${OS}"
  docker_result=$?

  if [[ docker_result -ne 0 ]]; then
    echo "Your system ${OS} is not supported trying with sub_os ${SUB_OS}"
    install_docker "${SUB_OS}"
    docker_sub_result=$?

    if [[ docker_sub_result -ne 0 ]]; then
      echo "Your system ${SUB_OS} is not supported please install docker manually"
      exit 1
    fi
  fi
fi

#install nginx https://gist.github.com/Dryam/3cd2e55a19e1954f1433
check_panel_script
check_os
installBase
removeFile "kiwi"
moveHome
Clone
moveFile
open_port 8443
Success
# rm install


