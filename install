#!/bin/bash
######################################################################
#                  KiwiPanel - a LOMP stack on Linux                 #
#                                                                    #
#                Author: Vuong Nguyen and contributors               #
#                  Website: https://kiwipanel.org                    #
#                  @since: 2025                                      #
#              Please do not remove copyright. Thanks!               #
#  Please do not copy under any circumstance for commercial reason!  #
######################################################################

######################################################################
# KiwiPanel Installer v0.0.1
# To install KiwiPanel copy the following instruction and paste to the terminal:
# curl -sLO https://raw.githubusercontent.com/kiwipanel/kiwipanel/main/install && chmod +x install && sudo bash install

######################################################################
clear
date
export LANG="${LANG:-en_US.UTF-8}"
export LC_ALL="${LC_ALL:-en_US.UTF-8}"

if command -v locale-gen >/dev/null 2>&1; then
    locale-gen en_US.UTF-8
fi


# Stop on error 
set -euo pipefail
trap 'LogError "Failed: command=\"$BASH_COMMAND\" line=$LINENO"' ERR

DEBUG=${DEBUG:-0}
AUTO_UPGRADE=${AUTO_UPGRADE:-0}

# Create log file
KIWIPANEL_DIR="/opt/kiwipanel"
LOG_DIR="$KIWIPANEL_DIR/logs"
LOG_FILE="$LOG_DIR/install.log"

mkdir -p "$LOG_DIR" || {
    echo "Failed to create log directory: $LOG_DIR"
    exit 1
}

touch "$LOG_FILE" || {
    echo "Failed to create log file: $LOG_FILE"
    exit 1
}

chmod 750 "$KIWIPANEL_DIR" "$LOG_DIR"
chmod 640 "$LOG_FILE"

function log() {
    local level="$1"
    shift
    local message="$*"
    local ts

    ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

    echo "$ts [$level] $message" >> "$LOG_FILE"
}

LogInfo()  { log INFO  "$@"; }
LogWarn()  { log WARN  "$@"; }
LogError() { log ERROR "$@"; }
LogDebug() { [[ "$DEBUG" == "1" ]] && log DEBUG "$@"; }

# Utilities ###########################################################
function PrintGreen() {
    local GREEN='\033[0;32m'
    local NC='\033[0m'
    local content="${1}"
    echo ""
    printf "${GREEN}${content}${NC}\n"
    LogInfo "$*"
}

function PrintInfo() {
    local CYAN='\033[0;36m'
    local NC='\033[0m'
    local content="${1}"
    echo ""
    printf "${CYAN}${content}${NC}\n"
    LogInfo "$*"
}

function PrintWarn() {
    local YELLOW_BROWN='\033[38;5;179m' # ANSI color code for yellow-brown
    local NC='\033[0m'                  # Reset to default color
    local content="${1}"
    printf "${YELLOW_BROWN}Warning: ${content}${NC}\n"
     LogWarn "$*"
}

function PrintRed() {
    local RED='\033[0;31m'
    local NC='\033[0m'
    local content="${1}"
    echo ""
    printf "${RED}Error: ${content}${NC}\n"
    LogError "$*"
}

function generate_random_string() {
    local length="${1:-12}"
    if command -v openssl >/dev/null 2>&1; then
        openssl rand -hex 6
    else    
        local result
        result=$(tr -dc 'a-z0-9' < /dev/urandom | head -c "$length" || true)
        echo "$result"      
    fi
}

# Check for sudo/root privileges######################################
if [ "$(id -u)" -ne 0 ]; then
    PrintRed "❌ You should install KiwiPanel as root or using sudo command."
    exit 1
fi

# Configuration########################################################
readonly KIWIPANEL_PORT=8443
kiwipanel_passcode=""
KIWI_VERSION="latest"
INSTALL_DIR="/opt/kiwipanel"
ZIP_URL="https://github.com/kiwipanel/kiwipanel/releases/download/v0.1.0/kiwipanel.zip"
TMP_ZIP="/tmp/kiwipanel.zip"
INSTALL_MARKER="/opt/kiwipanel/meta/.installed"
# Welcome########################################################
function ShowLogo {
    local kiwipanel_text=$(
        cat <<"EOF"
    ██╗░░██╗██╗░██╗░░░░░░░██╗██╗██████╗░░█████╗░███╗░░██╗███████╗██╗░░░░░
    ██║░██╔╝██║░██║░░██╗░░██║██║██╔══██╗██╔══██╗████╗░██║██╔════╝██║░░░░░
    █████═╝░██║░╚██╗████╗██╔╝██║██████╔╝███████║██╔██╗██║█████╗░░██║░░░░░
    ██╔═██╗░██║░░████╔═████║░██║██╔═══╝░██╔══██║██║╚████║██╔══╝░░██║░░░░░
    ██║░╚██╗██║░░╚██╔╝░╚██╔╝░██║██║░░░░░██║░░██║██║░╚███║███████╗███████╗
    ╚═╝░░╚═╝╚═╝░░░╚═╝░░░╚═╝░░╚═╝╚═╝░░░░░╚═╝░░╚═╝╚═╝░░╚══╝╚══════╝╚══════╝
EOF
    )
    echo ""
    PrintGreen "${kiwipanel_text}"
    echo ""
}

#Check if kiwipanel (CLI) has been installed. Stop if yes.
if systemctl status kiwipanel.service >/dev/null 2>&1; then
    PrintRed "KiwiPanel service has already been installed. Abort installation."
    PrintRed "Please install on a fresh compute or manually remove the existing service."
    exit 1
else
    PrintGreen "Welcome! Thanks for choosing KiwiPanel!"
fi

# Detect the system's architecture
ARCHITECTURE=$(uname -m)
#

kiwipanel_d_start_time=$(date +%s)
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' #NC: Not color: reset color to the default
IPADDRESS=$(curl -s --connect-timeout 5 https://cpanel.net/showip.cgi || hostname -I | awk '{print $1}')
DIR=$(pwd)
readonly kernel_version=$(uname -r)


#Reference: https://www.cloudron.io/get.html
readonly MINIMUM_DISK_SIZE_GB="5"
readonly MINIMUM_MEMORY="420" #on Amazon lightsail 423MB, 512MB is not always available
readonly rootfs_type=$(LC_ALL=C df --output=fstype / | tail -n1)
readonly physical_memory=$(LC_ALL=C free -m | awk '/Mem:/ { print $2 }')
readonly disk_size_bytes=$(LC_ALL=C df --output=size / | tail -n1)
readonly disk_size_gb=$((${disk_size_bytes} / 1024 / 1024))
readonly current_swap=$(free | awk '/^Swap:/ {print $3}')


# Verify the system has minimum requirements met
if [[ "${rootfs_type}" != "ext4" && "${rootfs_type}" != "xfs" ]]; then
    echo "Error: KiwiPanel requires '/' to be ext4 or xfs" # see #364
    exit 1
fi

if [[ "${physical_memory}" -lt "${MINIMUM_MEMORY}" ]]; then
    echo "Error: KiwiPanel requires at least 512MB physical memory"
    exit 1
fi

if [[ "${disk_size_gb}" -lt "${MINIMUM_DISK_SIZE_GB}" ]]; then
    echo "Error: KiwiPanel requires atleast 5GB disk space (Disk space on / is ${disk_size_gb}GB)"
    exit 1
fi



###################################################################################
function welcome() {
    ShowLogo
    printf "${GREEN}========================================================\n${NC}"
    echo "                   KIWIPANEL.COM Scripts                  "
    echo "            Auto Install & Optimize LOMP Stack            "
    printf "${GREEN}========================================================\n${NC}"
    echo ""
    PrintInfo "Installing KiwiPanel..."
    sleep 3
}

# Control Panel path
# @credit: https://github.com/sanvu88/lempstack/blob/master/install
CPANEL="/usr/local/cpanel/cpanel"
DIRECTADMIN="/etc/init.d/directadmin"
PLESK="/usr/local/psa/version"
WEBMIN="/etc/init.d/webmin"
SENTORA="/root/passwords.txt"
HOCVPS="/etc/hocvps/scripts.conf"
VPSSIM="/home/vpssim.conf"
EEV3="/usr/local/bin/ee"
WORDOPS="/usr/local/bin/wo"
KUSANAGI="/home/kusanagi"
CWP="/usr/local/cwpsrv"
VESTA="/usr/local/vesta/"
EEV4="/opt/easyengine"
LARVPS="/etc/larvps/.info.conf"
TINO="/opt/tinopanel"
WEBINOLY="/opt/webinoly/webinoly.conf"
CYBERPANEL="/usr/local/lscp"
WPTANGTOC="/etc/wptt/.wptt.conf"
HOSTVN="var/hostvn/hostvn.conf"
AAPANEL="/www/server/panel"

function check_panel_script() {
    PrintInfo "Checking the existing script or panel. You should install KiwiPanel on a fresh compute!"
    sleep 2

    # aaPanel
    if [ -d /www/server/panel ] || [ -f /usr/bin/bt ]; then
        PrintRed "Your server has aaPanel installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # cPanel / WHM
    if [ -f /var/cpanel/cpanel.config ]; then
        PrintRed "Your server has WHM/cPanel installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # Plesk
    if [ -d /usr/local/psa ]; then
        PrintRed "Your server has Plesk installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # Kusanagi
    if [ -f /etc/kusanagi ]; then
        PrintRed "Your server has Kusanagi installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # DirectAdmin
    if [ -f /usr/local/directadmin/conf/directadmin.conf ]; then
        PrintRed "Your server has DirectAdmin installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # Webmin
    if [ -f /etc/webmin/miniserv.conf ]; then
        PrintRed "Your server has Webmin installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # Webinoly
    if [ -d /opt/webinoly ]; then
        PrintRed "Your server has Webinoly installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # CyberPanel
    if [ -d /usr/local/CyberPanel ]; then
        PrintRed "Your server has CyberPanel installed, please reinstall your OS to use KiwiPanel"
        exit 1
    fi

    # LiteSpeed (OLS or Enterprise)
    # if [ -d /usr/local/lsws ] || [ -d /home/lsws ]; then
    #     PrintRed "Your server has LiteSpeed installed — KiwiPanel can only be installed on a fresh VPS."
    #     exit 1
    # fi

    PrintGreen "No conflicting panels detected. Continuing installation..."
    sleep 1
}


function check_architecture() {
    PrintInfo "Checking architechture. Kiwipanel supports 64 bits system only!"
    sleep 2    
    # Ref: https://raw.githubusercontent.com/runtipi/runtipi/master/scripts/install.sh
    # Not supported on 32 bits systems.
    # Note: aarch64 [ARM 64-bit (also known as AArch64), armv7: 32-bit ARM]
    local ARCHITECTURE="$(uname -m)"
    if [[ "$ARCHITECTURE" == "armv7"* ]] || [[ "$ARCHITECTURE" == "i686" ]] || [[ "$ARCHITECTURE" == "i386" ]]; then
        PrintRed "KiwiPanel currently does not support the 32 bits systems"
        exit 1
    fi
}

# =========================
# OS Detection (refactored)
# =========================

function load_os_release() {
    local file="${1:-/etc/os-release}"

    if [[ ! -f "$file" ]]; then
        PrintRed "Cannot detect operating system (missing /etc/os-release)"
        exit 1
    fi

    # shellcheck disable=SC1090
    source "$file"

    OS_ID="$ID"
    OS_VERSION_MAJOR="${VERSION_ID%%.*}"
    OS_LIKE="${ID_LIKE:-}"
    OS_NAME="${PRETTY_NAME:-$NAME}"
}

check_os() {
    PrintInfo "Checking operating system compatibility..."
    sleep 1

    load_os_release

    PrintInfo "Detected OS: ${OS_NAME}"
    PrintInfo "Kernel: $(uname -r)"

    # ---- Reject CentOS Stream explicitly ----
    if [[ "${OS_ID}" == "centos" && "${NAME}" =~ Stream ]]; then
        PrintRed "CentOS Stream is not supported."
        PrintRed "Please use Rocky Linux or AlmaLinux instead."
        exit 1
    fi

    case "${OS_ID}" in
        debian)
            if (( OS_VERSION_MAJOR < 11 )); then
                PrintRed "Debian ${VERSION_ID} is not supported."
                PrintRed "Please use Debian 11, 12, or 13."
                exit 1
            fi
            ;;
        ubuntu)
            if (( OS_VERSION_MAJOR < 22 )); then
                PrintRed "Ubuntu ${VERSION_ID} is not supported."
                PrintRed "Please use Ubuntu 22.04 or newer."
                exit 1
            fi
            ;;
        rhel|rocky|almalinux|ol|cloudlinux|vzlinux)
            if (( OS_VERSION_MAJOR < 8 )); then
                PrintRed "RHEL-compatible ${VERSION_ID} is not supported."
                PrintRed "Please use version 8 or newer."
                exit 1
            fi
            ;;
        *)
            if [[ "${OS_LIKE}" == *"rhel"* ]]; then
                if (( OS_VERSION_MAJOR < 8 )); then
                    PrintRed "RHEL-compatible ${VERSION_ID} is not supported."
                    exit 1
                fi
            else
                PrintRed "Unsupported operating system."
                PrintRed "Supported: Debian 11+, Ubuntu 22.04+, Rocky/Alma/RHEL 8+"
                exit 1
            fi
            ;;
    esac

    PrintGreen "Operating system is supported ✔"
}

#Check port https://ping.eu/port-chk/check_port_usage() {
function check_port_usage() {
    local port="$1"
    PrintInfo "Checking port $port..."
    if ss -tuln | awk '{print $5}' | grep -q ":$port$"; then
        echo "❌ Port $port is already in use. KiwiPanel needs this port."
        return 1
    fi
    PrintGreen "✅ Port $port is free."
}


function check_condition_before_install() {
    PrintInfo "Evaluating your VPS before installing KiwiPanel....."
    sleep 2
    check_os
    check_architecture
    check_panel_script
    # If port is used, exit with error
    check_port_usage 8443 || exit 1
}

#====================================Start Installing KiwiPanel ====================================
function prepare_directories() {
    PrintInfo "==> Preparing directories"
    mkdir -p "$INSTALL_DIR"
}


function show_version() {
    META_DIR="/opt/kiwipanel/meta"
    VERSION_FILE="$META_DIR/version"
    RELEASES_FILE="$META_DIR/releases.json"

    RELEASES_URL="https://raw.githubusercontent.com/kiwipanel/kiwipanel/refs/heads/main/releases.json"

    mkdir -p "$META_DIR"

    # Fetch releases catalog
    RELEASES_JSON=$(curl -fsSL "$RELEASES_URL")

    # Cache full releases.json locally (replaceable cache)
    echo "$RELEASES_JSON" > "$RELEASES_FILE"

    # Detect OS
    OS="linux"

    # Detect architecture
    ARCH=$(uname -m)
    case "$ARCH" in
        x86_64) ARCH="amd64" ;;
        aarch64|arm64) ARCH="arm64" ;;
        *)
            echo "Unsupported architecture: $ARCH"
            exit 1
            ;;
    esac

    # Get latest version string
    LATEST_VERSION=$(jq -r '.latest' <<<"$RELEASES_JSON")

    # Select matching release
    RELEASE=$(jq -r \
        --arg os "$OS" \
        --arg arch "$ARCH" \
        --arg ver "$LATEST_VERSION" '
        .releases[]
        | select(.version==$ver and .os==$os and .arch==$arch)
    ' <<<"$RELEASES_JSON")

    if [[ -z "$RELEASE" ]]; then
        echo "No compatible release found for $OS/$ARCH (version $LATEST_VERSION)"
        exit 1
    fi

    VERSION=$(jq -r '.version' <<<"$RELEASE")
    URL=$(jq -r '.download_url' <<<"$RELEASE")
    NOTES=$(jq -r '.notes' <<<"$RELEASE")
    RELEASE_DATE=$(jq -r '.release_date' <<<"$RELEASE")

    # Write plain-text version pointer (authoritative)
    echo "$VERSION" > "$VERSION_FILE"

    echo "Latest Version : $VERSION"
    echo "Release Date  : $RELEASE_DATE"
    echo "Architecture  : $ARCH"
    echo "Notes         : $NOTES"

    # Export for installer/update steps
    export KIWIPANEL_VERSION="$VERSION"
    export KIWIPANEL_DOWNLOAD_URL="$URL"
    export KIWIPANEL_ARCH="$ARCH"
    export KIWIPANEL_OS="$OS"

    sleep 1
}


function download_package() {
    PrintInfo "==> Downloading KiwiPanel package"
    if ! curl -L --fail "$ZIP_URL" -o "$TMP_ZIP"; then
        echo "❌ Failed to download KiwiPanel package. Exiting."
        exit 1
    fi
}

function extract_package() {
    PrintInfo "==> Extracting files"
    unzip -oq "$TMP_ZIP" -d /opt/ || {
        PrintRed "Failed to extract KiwiPanel"
        exit 1
    }
}

function create_group_and_user() {
    PrintInfo "==> Creating kiwisecure group"
    getent group kiwisecure >/dev/null || groupadd kiwisecure    
    PrintInfo "==> Creating kiwipanel user"
    if ! id kiwipanel >/dev/null 2>&1; then
        useradd --system \
            --no-create-home \
            --home-dir "$INSTALL_DIR" \
            --shell /usr/sbin/nologin \
            kiwipanel
    fi    
}


#------------------------------------------------------------Fixing ownership and permissions (because root created files beforehand
function fix_permissions() {
    PrintInfo "==> Setting proper ownership and permissions"
    # Ownership
    chown -R kiwipanel:kiwisecure "$INSTALL_DIR"
    # Directories: rwx for owner+group
    find "$INSTALL_DIR" -type d -exec chmod 750 {} \;
    # Files: rw for owner+group
    find "$INSTALL_DIR" -type f -exec chmod 640 {} \;
    # Real binary: executable by owner+group only
    chmod 750 "$INSTALL_DIR/bin/kiwipanel"
}

function fix_script_permissions() {
    PrintInfo "==> Setting script permissions in /opt/kiwipanel/scripts"
    local SCRIPT_DIR="$INSTALL_DIR/scripts"

    if [ -d "$SCRIPT_DIR" ]; then
        # Make scripts executable by owner and group only
        find "$SCRIPT_DIR" -type f -exec chmod 750 {} \;
        
        # Change ownership to kiwipanel user and kiwisecure group
        chown -R kiwipanel:kiwisecure "$SCRIPT_DIR"
        
        PrintGreen "✓ Scripts are now executable by kiwipanel user"
    else
        PrintInfo "⚠ No scripts directory found at $SCRIPT_DIR"
    fi
}

function create_system_directories() {
    PrintInfo "==> Creating KiwiPanel system directories"
    mkdir -p /etc/kiwipanel/{sites,users}
    mkdir -p /var/log/kiwipanel
    mkdir -p /var/lib/kiwipanel
    chown -R kiwipanel:kiwisecure /etc/kiwipanel
    chown -R kiwipanel:kiwisecure /var/log/kiwipanel
    chown -R kiwipanel:kiwisecure /var/lib/kiwipanel
    chmod 750 /etc/kiwipanel
    chmod 750 /etc/kiwipanel/sites /etc/kiwipanel/users
    chmod 750 /var/log/kiwipanel
    chmod 750 /var/lib/kiwipanel
}


function install_wrapper() {
    PrintInfo "Installing kiwipanel CLI wrapper"

    cat > /usr/local/bin/kiwipanel <<'EOF'
#!/bin/bash
set -uo pipefail

if [ "$(id -u)" -ne 0 ]; then
  echo "Error: kiwipanel requires root privileges" >&2
  exit 1
fi

REAL_BIN="/opt/kiwipanel/bin/kiwipanel"
BASE_DIR="/opt/kiwipanel"

if [ ! -e "$REAL_BIN" ]; then
  echo "KiwiPanel error: binary not found at $REAL_BIN" >&2
  exit 1
fi

if [ ! -r "$REAL_BIN" ]; then
  echo "KiwiPanel error: binary is not readable" >&2
  exit 1
fi

if [ ! -x "$REAL_BIN" ]; then
  echo "KiwiPanel error: binary is not executable" >&2
  echo "Fix: chmod 750 $REAL_BIN" >&2
  exit 1
fi

OWNER=$(stat -c '%U:%G' "$REAL_BIN")
if [ "$OWNER" != "kiwipanel:kiwisecure" ]; then
  echo "KiwiPanel error: invalid binary ownership: $OWNER" >&2
  echo >&2
  echo "This binary must be owned by the service account." >&2
  echo >&2
  echo "Fix (run as root):" >&2
  echo "  chown kiwipanel:kiwisecure $REAL_BIN" >&2
  echo "  chmod 750 $REAL_BIN" >&2
  echo >&2  
  exit 1
fi

if [ ! -x "$BASE_DIR" ]; then
  echo "KiwiPanel error: cannot access working directory $BASE_DIR" >&2
  echo "Fix (run as root):" >&2
  echo "  chown -R kiwipanel:kiwisecure $BASE_DIR" >&2
  echo "  chmod 750 $BASE_DIR" >&2  
  exit 1
fi

exec "$REAL_BIN" "$@"
EOF

    chown root:root /usr/local/bin/kiwipanel
    chmod 755 /usr/local/bin/kiwipanel
    PrintGreen "KiwiPananel CLI installed successfully"
}


#------------------------------------------------------------Create passcode to protect login page
function generate_the_passcode() {
    local META_DIR="/opt/kiwipanel/meta"
    local PASSCODE_FILE="$META_DIR/passcode"
    local INSTALL_MARKER="$META_DIR/.installed"

    mkdir -p "$META_DIR"

    if [[ -f "$INSTALL_MARKER" && -f "$PASSCODE_FILE" ]]; then
        kiwipanel_passcode=$(tr -d '\n' < "$PASSCODE_FILE")
        PrintGreen "Existing passcode preserved."
        return
    fi

    kiwipanel_passcode=$(generate_random_string)
    printf '%s\n' "$kiwipanel_passcode" > "$PASSCODE_FILE"

    chown kiwipanel:kiwisecure "$PASSCODE_FILE"
    chmod 640 "$PASSCODE_FILE"

    touch "$INSTALL_MARKER"
    chown kiwipanel:kiwisecure "$INSTALL_MARKER"
    chmod 640 "$INSTALL_MARKER"

    PrintGreen "New passcode generated."
}


#------------------------------------------------------------Installing systemd service file
function install_systemd_service() {        
    if [ -f /etc/systemd/system/kiwipanel.service ]; then
        cp /etc/systemd/system/kiwipanel.service \
           /etc/systemd/system/kiwipanel.service.bak
    fi
    # Copy systemd service file from extracted ZIP    
    cp "$INSTALL_DIR/data/kiwipanel.service" "/etc/systemd/system/kiwipanel.service"
    chmod 644 /etc/systemd/system/kiwipanel.service
    systemctl daemon-reload
    systemctl enable kiwipanel.service
    systemctl start kiwipanel.service

     # Wait for service to be ready
    PrintInfo "Waiting for KiwiPanel service to start..."
    local timeout=5
    local elapsed=0    
    while [ $elapsed -lt $timeout ]; do
        if systemctl is-active --quiet kiwipanel.service; then
            PrintGreen "✓ KiwiPanel service started successfully"
            return 0
        fi
        sleep 1
        ((elapsed++))
    done    
    PrintWarn "⚠ KiwiPanel service did not start within ${timeout}s"
    systemctl status kiwipanel.service --no-pager || true
    
}
function install_login_banner() {
    local PROFILE_D="/etc/profile.d/kiwipanel.sh"
    # Ensure /etc/profile.d exists
    mkdir -p /etc/profile.d
    chmod 755 /etc/profile.d
    cat > "$PROFILE_D" <<'EOF'
#!/bin/bash
# =========================================================
# KiwiPanel login banner
# Created by KiwiPanel installer
# Authors: Vuong Nguyen <vuong@kiwipanel.org>
# =========================================================

[[ $- != *i* ]] && return

if [[ $EUID -ne 0 && "$(whoami)" != "kiwipanel" ]]; then
    return
fi

KIWIPANEL_BIN=$(command -v kiwipanel 2>/dev/null)
[ -z "$KIWIPANEL_BIN" ] && return

# Color codes
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
GRAY='\033[0;90m'
NC='\033[0m'

BOX_WIDTH=70
TEXT="KiwiPanel System Information"
PLAIN_TEXT=$(echo -e "$TEXT" | sed 's/\x1b\[[0-9;]*m//g')
TEXT_LEN=${#PLAIN_TEXT}
PADDING_LEFT=$(( (BOX_WIDTH - 2 - TEXT_LEN) / 2 ))
PADDING_RIGHT=$(( BOX_WIDTH - 2 - TEXT_LEN - PADDING_LEFT ))

VERSION_FILE="/opt/kiwipanel/meta/version"
KIWI_VERSION="unknown"
[ -f "$VERSION_FILE" ] && KIWI_VERSION=$(cat "$VERSION_FILE" 2>/dev/null || echo "unknown")

# Memory info
TOTAL_MEM=$(free -h | awk '/^Mem:/ {print $2}')
USED_MEM=$(free -h | awk '/^Mem:/ {print $3}')
MEM_PERCENT=$(free | awk '/^Mem:/ {printf "%.0f", ($3/$2) * 100}')

# Disk info
TOTAL_DISK=$(df -h / | awk 'NR==2 {print $2}')
USED_DISK=$(df -h / | awk 'NR==2 {print $3}')
DISK_PERCENT=$(df / | awk 'NR==2 {print $5}' | tr -d '%')

# Swap info
SWAP_TOTAL=$(free -h | awk '/^Swap:/ {print $2}')
SWAP_USED=$(free -h | awk '/^Swap:/ {print $3}')
SWAP_PERCENT=$(free | awk '/^Swap:/ {if($2>0) printf "%.0f", ($3/$2) * 100; else print "0"}')

# System info
UPTIME=$(uptime -p | sed 's/up //')
LOAD_AVG=$(uptime | awk -F'load average:' '{print $2}' | xargs)
IPADDR=$(hostname -I | awk '{print $1}')
INSTALL_DATE=$(stat -c %y /opt/kiwipanel 2>/dev/null | cut -d' ' -f1)

# Service status
if systemctl is-active --quiet kiwipanel.service 2>/dev/null; then
    SERVICE_STATUS="${GREEN}●${NC} Running"
    SERVICE_UPTIME=$(systemctl show kiwipanel.service -p ActiveEnterTimestamp --value 2>/dev/null | xargs -I{} date -d "{}" +%s 2>/dev/null || echo "0")
    if [ "$SERVICE_UPTIME" != "0" ]; then
        CURRENT_TIME=$(date +%s)
        SERVICE_RUNTIME=$((CURRENT_TIME - SERVICE_UPTIME))
        if [ $SERVICE_RUNTIME -ge 86400 ]; then
            SERVICE_RUNTIME_STR=$(printf '%dd %dh' $((SERVICE_RUNTIME/86400)) $((SERVICE_RUNTIME%86400/3600)))
        elif [ $SERVICE_RUNTIME -ge 3600 ]; then
            SERVICE_RUNTIME_STR=$(printf '%dh %dm' $((SERVICE_RUNTIME/3600)) $((SERVICE_RUNTIME%3600/60)))
        else
            SERVICE_RUNTIME_STR=$(printf '%dm' $((SERVICE_RUNTIME/60)))
        fi
    else
        SERVICE_RUNTIME_STR="just started"
    fi
else
    SERVICE_STATUS="${RED}●${NC} Stopped"
    SERVICE_RUNTIME_STR="N/A"
fi

# Function to draw colored usage bar
draw_bar() {
    local PERCENT=$1
    local BAR_WIDTH=20
    local FILLED=$(( PERCENT * BAR_WIDTH / 100 ))
    local EMPTY=$(( BAR_WIDTH - FILLED ))
    
    # Choose color based on usage
    local COLOR
    if [ "$PERCENT" -lt 60 ]; then
        COLOR="$GREEN"
    elif [ "$PERCENT" -lt 80 ]; then
        COLOR="$YELLOW"
    else
        COLOR="$RED"
    fi
    
    # Build the bar
    local BAR=""
    for ((i=0; i<FILLED; i++)); do BAR+="▰"; done
    local EMPTY_BAR=""
    for ((i=0; i<EMPTY; i++)); do EMPTY_BAR+="▱"; done
    
    echo -ne "${COLOR}${BAR}${GRAY}${EMPTY_BAR}${NC} ${PERCENT}%"
}

# Function to pad string to fixed width
pad_string() {
    local str="$1"
    local width=$2
    printf "%-${width}s" "$str"
}

# Display banner
echo
echo -e "${GREEN}╔$(printf '═%.0s' $(seq 1 $((BOX_WIDTH-2))))╗${NC}"
printf "${GREEN}║${NC}%*s${CYAN}%s${NC}%*s${GREEN}║${NC}\n" $PADDING_LEFT "" "$TEXT" $PADDING_RIGHT ""
echo -e "${GREEN}╚$(printf '═%.0s' $(seq 1 $((BOX_WIDTH-2))))╝${NC}"
echo
echo -e "  ${YELLOW}Version:${NC}      ${KIWI_VERSION}"
echo -e "  ${YELLOW}Service:${NC}      ${SERVICE_STATUS} (uptime: ${SERVICE_RUNTIME_STR})"
echo -e "  ${YELLOW}Uptime:${NC}       ${UPTIME}"
echo -e "  ${YELLOW}Load Avg:${NC}     ${LOAD_AVG}"
echo -e "  ${YELLOW}IP Address:${NC}   ${IPADDR}"
echo -e "  ${YELLOW}Installed:${NC}    ${INSTALL_DATE}"
echo

# Memory usage
MEM_LABEL=$(pad_string "Memory:" 8)
MEM_USAGE=$(pad_string "${USED_MEM} / ${TOTAL_MEM}" 15)
echo -ne "  ${YELLOW}${MEM_LABEL}${NC}  ${MEM_USAGE}  "
draw_bar "$MEM_PERCENT"
echo

# Disk usage
DISK_LABEL=$(pad_string "Disk:" 8)
DISK_USAGE=$(pad_string "${USED_DISK} / ${TOTAL_DISK}" 15)
echo -ne "  ${YELLOW}${DISK_LABEL}${NC}  ${DISK_USAGE}  "
draw_bar "$DISK_PERCENT"
echo

# Swap usage (only show if swap exists)
if [ "$SWAP_TOTAL" != "0B" ] && [ -n "$SWAP_TOTAL" ] && [ "$SWAP_TOTAL" != "0" ]; then
    SWAP_LABEL=$(pad_string "Swap:" 8)
    SWAP_USAGE=$(pad_string "${SWAP_USED} / ${SWAP_TOTAL}" 15)
    echo -ne "  ${YELLOW}${SWAP_LABEL}${NC}  ${SWAP_USAGE}  "
    draw_bar "$SWAP_PERCENT"
    echo
fi

# Warning indicators
WARNINGS=0
echo
if [ "$MEM_PERCENT" -gt 90 ]; then
    echo -e "  ${RED}⚠ Warning: Memory usage is critically high (${MEM_PERCENT}%)${NC}"
    WARNINGS=$((WARNINGS + 1))
fi

if [ "$DISK_PERCENT" -gt 90 ]; then
    echo -e "  ${RED}⚠ Warning: Disk space is critically low (${DISK_PERCENT}%)${NC}"
    WARNINGS=$((WARNINGS + 1))
fi

if [ "$DISK_PERCENT" -gt 80 ] && [ "$DISK_PERCENT" -le 90 ]; then
    echo -e "  ${YELLOW}⚠ Notice: Disk space is running low (${DISK_PERCENT}%)${NC}"
    WARNINGS=$((WARNINGS + 1))
fi

if ! systemctl is-active --quiet kiwipanel.service 2>/dev/null; then
    echo -e "  ${RED}⚠ Warning: KiwiPanel service is not running!${NC}"
    WARNINGS=$((WARNINGS + 1))
fi

# Add spacing only if warnings were shown
if [ $WARNINGS -gt 0 ]; then
    echo
fi

"$KIWIPANEL_BIN" status
echo
echo -e "${CYAN}Quick commands:${NC}"
echo -e "  ${GRAY}kiwipanel status${NC}      # Show service status"
echo -e "  ${GRAY}kiwipanel check${NC}       # Check your current VPS status"
echo -e "  ${GRAY}kiwipanel hide${NC}        # Temporarily hide the KiwiPanel web interface"
echo
echo -e "${CYAN}Type '${NC}kiwipanel${CYAN}' to open the administration menu.${NC}"
echo
EOF

    chown root:root "$PROFILE_D"
    chmod 644 "$PROFILE_D"
}

function disable_default_motd() {
    PrintInfo "==> Normalizing login banner experience"

    # Debian / Ubuntu
    if [ -d /etc/update-motd.d ]; then
        chmod -x /etc/update-motd.d/* || true
        return
    fi

    # CentOS / RHEL / Alma / Rocky
    if [ -f /etc/redhat-release ]; then
        : > /etc/motd
        : > /etc/issue
        return
    fi
}

function cleanup() {
    rm -f "$TMP_ZIP"
    rm -rf /tmp/kiwipanel-* 2>/dev/null || true
    
    # Clean up any failed extraction attempts
    if [[ -d /opt/kiwipanel.tmp ]]; then
        rm -rf /opt/kiwipanel.tmp
    fi
}


#------------------------------------------------------------Create swap
#Recommendation about the amount of swap:
#https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/managing_storage_devices/getting-started-with-swap_managing-storage-devices
function create_swap() {
    PrintInfo "==> Checking swap configuration..."

    # Better detection: any active swap or existing /swapfile
    if swapon --show | grep -q . || [ -e /swapfile ]; then
        echo "Swap is already configured. Skipping creation."
        return
    fi

    total_ram_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    available_disk_kb=$(df / | tail -1 | awk '{print $4}')

    # Conservative sizing
    if [[ $total_ram_kb -le $((2 * 1024 * 1024)) ]]; then
        swap_size_kb=$total_ram_kb
    elif [[ $total_ram_kb -le $((8 * 1024 * 1024)) ]]; then
        swap_size_kb=$((2 * 1024 * 1024))
    else
        swap_size_kb=$((1 * 1024 * 1024))
    fi

    needed_kb=$((swap_size_kb + swap_size_kb / 10))  # +10% overhead

    if [[ $available_disk_kb -lt $needed_kb ]]; then
        PrintWarn "Insufficient disk space for ${swap_size_kb}K swap (need ~$((needed_kb/1024/1024 + 1)) GB free). Skipping."
        return
    fi

    PrintInfo "==> Creating ${swap_size_kb}K swap file at /swapfile..."

    if ! fallocate -l "${swap_size_kb}K" /swapfile 2>/dev/null; then
        PrintWarn "fallocate failed. Using dd (this may take a while)..."
        dd if=/dev/zero of=/swapfile bs=1M count=$((swap_size_kb / 1024)) status=progress || return 1
    fi

    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile

    # Avoid duplicates in fstab
    if ! grep -q '^/swapfile' /etc/fstab; then
        echo "/swapfile none swap sw 0 0" | tee -a /etc/fstab
    fi

    PrintGreen "Swap file created and enabled."
}

function InstallBaseCentos() {
    PrintInfo "Updating system on RHEL family..."    
    # 1. Handle SELinux (Critical for panels)
    # If SELinux is Enforcing (default on Rocky/Alma), 
    # your Nginx/PHP/KiwiPanel service will fail to start or fail to write logs, and the script will exit with an error.
    if command -v setenforce &> /dev/null; then
        setenforce 0
        sed -i 's/^SELINUX=.*/SELINUX=permissive/g' /etc/selinux/config
        PrintInfo "SELinux set to Permissive mode."
    fi

    PrintInfo "Updating system and installing base tools on CentOS-based distro..."    
    #dnf detection (future-proofing), dnf is available on CentOS 8+, AlmaLinux, RockyLinux
    PKG_MGR=$(command -v dnf || command -v yum) || {
        PrintRed "No supported package manager found"
        exit 1
    }
    $PKG_MGR update -y || { PrintRed "Failed to update package lists"; exit 1; }
    #--no-install-recommends is APT-only. For YUM/DNF, we just do a standard upgrade.    
    $PKG_MGR upgrade -y || { PrintRed "System upgrade failed"; exit 1; }

    $PKG_MGR install -y ca-certificates || {
        PrintRed "Failed to install ca-certificates"
        exit 1
    }
    
    #Install ca-certificates first, then EPEL.
    rpm -q epel-release >/dev/null 2>&1 || $PKG_MGR install -y epel-release

    $PKG_MGR install -y \
        gnupg2 \
        procps-ng \
        wget curl git zip unzip nano \
        openssl cronie lsof jq || {
            PrintRed "Failed to install base packages"
            exit 1
        }
        
    #The || true ensures the script continues even if crond is already enabled/started or the command fails 
    #(e.g., in a container where systemd isn't running).
    systemctl enable crond >/dev/null 2>&1 || true
    systemctl start crond  >/dev/null 2>&1 || true
}

function InstallBaseUbuntu() {
    PrintInfo "Updating system and installing base tools on Debian-based distro..."   
    export DEBIAN_FRONTEND=noninteractive        
    apt-get update -y || { PrintRed "Failed to update package lists"; exit 1; }
    #Using --no-install-recommends on upgrade is a great practice, especially in automated scripts, 
    #as it prevents potentially unwanted package creep.    
    
    if [[ "$AUTO_UPGRADE" == "1" ]]; then
        apt-get -y upgrade --no-install-recommends || {
            PrintRed "System upgrade failed"
            exit 1
        }   
    fi

    apt-get install -y \
        ca-certificates \
        gnupg \
        lsb-release \
        procps \
        wget curl git zip unzip nano \
        openssl cron lsof jq || {
            PrintRed "Failed to install base packages"
            exit 1
        }
    #Ubuntu often installs but does not start cron in minimal images. Ensure it's started.    
    systemctl enable cron >/dev/null 2>&1 || true
    systemctl start cron  >/dev/null 2>&1 || true
}


# Install the base system for the specified distribution.
function install_base() {        
    PrintInfo "Installing base system dependencies..."
    case "$OS_ID" in
        ubuntu|debian)
            InstallBaseUbuntu
            ;;
        rocky|almalinux|centos|rhel|ol|cloudlinux|vzlinux)
            InstallBaseCentos
            ;;
        *)
            PrintRed "Unsupported OS: $OS_ID"
            exit 1
            ;;
    esac
}

function install_firewall() {
    PrintInfo "Installing and configuring firewall (UFW)..."

    case "$OS_ID" in
        debian|ubuntu)
            apt-get update -y
            apt-get install -y ufw || {
                PrintRed "Failed to install UFW"
                exit 1
            }
            ;;
        rocky|almalinux|rhel|ol|cloudlinux|vzlinux)
            if command -v firewall-cmd >/dev/null 2>&1; then
                PrintInfo "Removing firewalld (required for KiwiPanel)"
                systemctl disable --now firewalld || true
                dnf remove -y firewalld
            fi

            dnf install -y epel-release
            dnf install -y ufw || {
                PrintRed "Failed to install UFW"
                exit 1
            }
            ;;
        *)
            PrintRed "Unsupported OS for firewall installation: $OS_ID"
            exit 1
            ;;
    esac

    ufw --force reset
    ufw default deny incoming
    ufw default allow outgoing

    ufw allow 22/tcp
    ufw allow 80/tcp
    # ufw allow 443/tcp        
    ufw allow "$KIWIPANEL_PORT"/tcp

     # Explicitly deny OLS WebAdmin from internet
    ufw deny 7080/tcp
    ufw deny 8088/tcp  # Block old default port too

    ufw --force enable

    PrintGreen "Firewall enabled successfully"
    ufw status verbose
}


#############################################
# OpenLiteSpeed Installer (KiwiPanel)
# Standard / Official / Idempotent
#############################################

LSWS_DIR="/usr/local/lsws"
LSWS_CTRL="$LSWS_DIR/bin/lswsctrl"
PHP_VER="83"

# ------------------------------------------------------------------------------
# Detect OS (Ubuntu only – explicit)
# ------------------------------------------------------------------------------
detect_os() {
    if ! grep -qs "Ubuntu" /etc/os-release; then
        PrintRed "Unsupported OS. KiwiPanel supports Ubuntu only."
        exit 1
    fi
}

# ------------------------------------------------------------------------------
# Install LiteSpeed Repository (OFFICIAL)
# ------------------------------------------------------------------------------
install_repo() {
    if command -v lswsctrl >/dev/null 2>&1; then
        PrintInfo "LiteSpeed repository already configured"
        return
    fi

    PrintInfo "Installing LiteSpeed repository (official)"
    curl -fsSL https://repo.litespeed.sh | bash
}

# ------------------------------------------------------------------------------
# Install OpenLiteSpeed
# ------------------------------------------------------------------------------
install_ols() {
    if [[ -d "$LSWS_DIR" ]]; then
        PrintInfo "OpenLiteSpeed already installed"
        return
    fi

    PrintInfo "Installing OpenLiteSpeed"
    apt-get update -y
    apt-get install -y openlitespeed
    PrintGreen "Done: Installed OpenLiteSpeed"
}

# ------------------------------------------------------------------------------
# Ensure OpenLiteSpeed is enabled & running
# ------------------------------------------------------------------------------
ensure_running() {
    systemctl enable lshttpd >/dev/null 2>&1

    if "$LSWS_CTRL" status 2>/dev/null | grep -q running; then
        PrintGreen "OpenLiteSpeed is already running"
    else
        PrintInfo "Starting OpenLiteSpeed"
        systemctl start lshttpd
        sleep 2
        if "$LSWS_CTRL" status 2>/dev/null | grep -q running; then
            PrintGreen "OpenLiteSpeed started successfully"
        else
            PrintWarn "OpenLiteSpeed may not have started correctly"
            systemctl status lshttpd --no-pager || true
        fi
    fi
}

# ------------------------------------------------------------------------------
# Install LSPHP (no assumptions, no overrides)
# ------------------------------------------------------------------------------
function install_lsphp() {
    if [[ -x "$LSWS_DIR/lsphp${PHP_VER}/bin/lsphp" ]]; then
        PrintInfo "LSPHP ${PHP_VER} already installed"
        return
    fi

    PrintInfo "Installing LSPHP ${PHP_VER}"
    apt-get install -y \
        "lsphp${PHP_VER}" \
        "lsphp${PHP_VER}-common" \
        "lsphp${PHP_VER}-mysql"
    
    PrintGreen "Done: Installed LSPHP ${PHP_VER}"
}

# ------------------------------------------------------------------------------
# Configure OpenLiteSpeed listeners via httpd_config.conf (KiwiPanel-managed)
# ------------------------------------------------------------------------------
# IMPORTANT:
# OpenLiteSpeed listeners MUST be configured in httpd_config.conf
# systemd overrides cannot control listening ports
configure_lsws_default_listener() {
    local CONF="$LSWS_DIR/conf/httpd_config.conf"
    local LISTENER_NAME="HTTP"

    PrintInfo "Configuring OpenLiteSpeed HTTP listener on port 80 (KiwiPanel-managed)"

    # Backup once
    if [[ ! -f "${CONF}.bak" ]]; then
        cp "$CONF" "${CONF}.bak"
    fi

    # 1️⃣ Remove any existing KiwiPanel HTTP listener
    sed -i "/listener ${LISTENER_NAME} {/,/}/d" "$CONF"

    # 2️⃣ Remove *dangerous* Default listener on port 80 (if any)
    awk '
        BEGIN { in_listener=0 }
        /listener Default[[:space:]]*{/ { in_listener=1; buf=$0; next }
        in_listener && /}/ {
            buf = buf "\n" $0
            if (buf ~ /\*:80/) {
                in_listener=0
                next
            }
            print buf
            in_listener=0
            next
        }
        in_listener { buf = buf "\n" $0; next }
        { print }
    ' "$CONF" > "${CONF}.tmp" && mv "${CONF}.tmp" "$CONF"

    # 3️⃣ Append clean HTTP listener
    cat >> "$CONF" <<EOF

# =========================================================
# KiwiPanel-managed HTTP listener
# DO NOT EDIT MANUALLY
# =========================================================
listener ${LISTENER_NAME} {
    address                 *:80
    secure                  0
    map                     Example *
}
EOF

    PrintGreen "✓ HTTP listener configured cleanly on port 80"
}



# ------------------------------------------------------------------------------
# disable_7080
# ------------------------------------------------------------------------------

disable_7080() {
    local CONF="$LSWS_DIR/admin/conf/admin_config.conf"

    if grep -q "address.*:7080" "$CONF"; then
        PrintInfo "Restricting WebAdmin to localhost (7080)"
        sed -i 's/address.*/address 127.0.0.1:7080/' "$CONF"
        systemctl restart lshttpd
    else
        PrintInfo "WebAdmin listener already restricted"
    fi
}

configure_minimal_vhost() {
    local VHOST_ROOT="$LSWS_DIR/Example"
    local DOCROOT="$VHOST_ROOT/html"

    PrintInfo "Configuring minimal Example vhost"

    mkdir -p "$DOCROOT"

    cat > "$DOCROOT/index.html" <<'EOF'
<!DOCTYPE html>
<html>
<head><title>KiwiPanel</title></head>
<body>
<h1>KiwiPanel Server</h1>
<p>OpenLiteSpeed is running successfully!</p>
</body>
</html>
EOF

    chown -R lsadm:lsadm "$VHOST_ROOT"
    chmod -R 755 "$VHOST_ROOT"
}
# ------------------------------------------------------------------------------
# WebAdmin password (official mechanism only)
# ------------------------------------------------------------------------------
function ensure_admin_password() {
    if [[ -f "$LSWS_DIR/adminpasswd" ]]; then
        PrintInfo "WebAdmin password already initialized"
        return
    fi

    PrintInfo "Initializing WebAdmin password"
    "$LSWS_DIR/admin/misc/admpass.sh"
}

# ------------------------------------------------------------------------------
# Health checks (LiteSpeed-standard)
# ------------------------------------------------------------------------------
function health_check() {    
    if ss -tulnp | awk '$5 ~ /:80$/'; then
        PrintGreen "✓ OpenLiteSpeed is listening on port 80"
    else
        PrintRed "✗ OpenLiteSpeed failed to bind port 80"
        PrintRed "Installation aborted (listener misconfiguration)"
        exit 1
    fi
}


function verify(){
    PrintInfo "==> Verifying ownership"
    for path in /opt/kiwipanel /etc/kiwipanel /var/log/kiwipanel /var/lib/kiwipanel; do
    owner=$(stat -c "%U:%G" "$path")
    if [ "$owner" != "kiwipanel:kiwisecure" ]; then
        PrintWarn "$path ownership is $owner (expected kiwipanel:kiwisecure)"
    fi
    done
}

function post_install_check() {
    PrintInfo "==> Running post-installation health checks..."
    
    local errors=0
    
    # Determine cron service name based on OS
    local cron_service="cron"
    case "$OS_ID" in
        rocky|almalinux|centos|rhel|ol|cloudlinux|vzlinux)
            cron_service="crond"
            ;;
    esac
    
    # Check services
    for service in kiwipanel ufw "$cron_service"; do
        if systemctl is-active --quiet "$service" 2>/dev/null; then
            PrintGreen "✓ $service is running"
        else
            PrintWarn "✗ $service is not running"
            ((errors++))
        fi
    done
    
    # Check ports
    for port in 22 80 443 $KIWIPANEL_PORT; do
        if ss -tuln | grep -q ":$port"; then
            PrintGreen "✓ Port $port is configured"
        else
            PrintWarn "✗ Port $port is not listening"
        fi
    done
    
    # Check disk space
    local disk_free=$(df / | tail -1 | awk '{print $4}')
    if [ "$disk_free" -lt 1048576 ]; then  # Less than 1GB
        PrintWarn "Low disk space: $(($disk_free / 1024))MB free"
    fi
    
    # Check memory
    local mem_available=$(free -m | awk '/^Mem:/ {print $7}')
    if [ "$mem_available" -lt 100 ]; then
        PrintWarn "Low available memory: ${mem_available}MB"
    fi
    
    if [ $errors -eq 0 ]; then
        PrintGreen "All health checks passed!"
    else
        PrintWarn "Some checks failed - review warnings above"
    fi
}

function successMessage() {        
    PrintGreen "KiwiPanel has been successfully installed on your VPS!"
    kiwipanel_d_end_time=$(date +%s)
    local final_pass=$(cat "/opt/kiwipanel/meta/passcode")
    elapsed=$((kiwipanel_d_end_time - kiwipanel_d_start_time))
    printf " \n"
    echo "$(tput setaf 2)Total time installed: ${elapsed} seconds.$(tput sgr0)"
    printf " \n"
    echo "$(tput setaf 2)================================Install KiwiPanel Done!==============================$(tput sgr0)"
    echo ""
    echo "Login at : http://$IPADDRESS:$KIWIPANEL_PORT/$kiwipanel_passcode"
    echo ""    
    echo "   User:     admin" # or whatever your default user is
    echo "   Passcode: ${final_pass}"
    echo ""
    echo ""
    echo "$(tput setaf 2)=====================================================================================$(tput sgr0)"
    LogInfo "Installation completed successfully"
}

function installkiwipanel() {
    prepare_directories
    show_version
    download_package
    extract_package
    create_group_and_user      # ✅ Create user/group FIRST
    create_system_directories
    fix_permissions            # ✅ Then fix general permissions
    fix_script_permissions     # ✅ Then fix script permissions
    install_wrapper
    generate_the_passcode 
    install_systemd_service
    install_login_banner
    disable_default_motd
}

# ------------------------------------------------------------------------------
# Main flow
# ------------------------------------------------------------------------------
function install_litespeed_server() {
    detect_os
    install_repo
    install_ols
    install_lsphp
    ensure_admin_password
    ensure_running    
    configure_lsws_default_listener    
    disable_7080
    configure_minimal_vhost
    
    # ✅ Graceful restart to apply all changes
    PrintInfo "Restarting OpenLiteSpeed"
    systemctl restart lshttpd
    sleep 2

    health_check
}

function main() {
    welcome
    check_condition_before_install       
    install_base        
    create_swap
    install_firewall
    install_litespeed_server
    installkiwipanel    
    verify
    post_install_check
    successMessage    
    cleanup
}

main
